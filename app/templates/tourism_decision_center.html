{% extends 'base.html' %}

{% block title %}旅游决策中心{% endblock %}

{% block styles %}
<style>
    /* 决策流程样式 */
    .decision-flow {
        display: flex;
        justify-content: space-between;
        margin: 30px 0;
        flex-wrap: wrap;
    }

    .flow-item {
        text-align: center;
        flex: 1;
        min-width: 150px;
        margin: 10px;
    }

    .flow-circle {
        width: 60px;
        height: 60px;
        background: var(--gradient-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: bold;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        position: relative;
        overflow: hidden;
    }

    .flow-circle::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
        z-index: 1;
    }

    .flow-circle * {
        position: relative;
        z-index: 2;
    }

    .flow-circle.active {
        background: var(--gradient-success);
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .flow-circle.completed {
        background: var(--gradient-info);
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .flow-connector {
        position: relative;
        margin: 0 20px;
    }

    .flow-connector::after {
        content: "→";
        font-size: 1.5rem;
        color: var(--secondary-color);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .step-container {
        display: none;
    }

    .step-container.active {
        display: block;
    }

    .hidden {
        display: none;
    }

    /* 决策步骤样式 */
    .decision-step {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        padding: 30px;
        margin-bottom: 24px;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }

    .decision-step:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-shadow-hover);
    }

    .step-icon {
        font-size: 2.5rem;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 20px;
        filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));
    }

    .step-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 12px;
        color: var(--text-primary);
        letter-spacing: -0.5px;
    }

    .step-description {
        color: var(--text-secondary);
        margin-bottom: 20px;
        font-size: 1.05rem;
        line-height: 1.6;
    }

    /* 结果区域样式 */
    .result-section {
        margin-top: 30px;
        padding: 24px;
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(0, 0, 0, 0.05);
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">辽宁省智慧旅游决策中心</h1>

    <!-- 决策流程 -->
    <div class="decision-flow">
        <div class="flow-item">
            <div class="flow-circle">1</div>
            <h5>目的地选择</h5>
        </div>
        <div class="flow-connector"></div>
        <div class="flow-item">
            <div class="flow-circle">2</div>
            <h5>景点推荐</h5>
        </div>
        <div class="flow-connector"></div>
        <div class="flow-item">
            <div class="flow-circle">3</div>
            <h5>行程规划</h5>
        </div>
        <div class="flow-connector"></div>
        <div class="flow-item">
            <div class="flow-circle">4</div>
            <h5>出行准备</h5>
        </div>
    </div>

    <!-- 决策步骤卡片 -->
    <div class="step-container active" id="step-1">
        <div class="row">
            <!-- 步骤1: 目的地选择 -->
            <div class="col-md-6 offset-md-3">
                <div class="decision-step">
                    <i class="bi bi-map-pin-fill step-icon"></i>
                    <h3 class="step-title">1. 目的地选择</h3>
                    <p class="step-description">基于天气预测和客流量数据，选择最适合您出行的目的地</p>

                    <div class="card feature-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">目的地筛选</h5>
                        </div>
                        <div class="card-body">
                            <form method="GET" action="{{ url_for('tourism_decision_center.index') }}" class="row g-3">
                                <div class="col-md-12">
                                    <label for="travel_date" class="form-label">计划出行日期</label>
                                    <input type="date" class="form-control" id="travel_date" name="travel_date"
                                        value="{{ request.args.get('travel_date', '') }}">
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">查询城市推荐指数</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 城市推荐指数结果 -->
                    {% if city_scores %}
                    <div class="result-section mt-4">
                        <h5>城市推荐指数</h5>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped">
                                <thead class="sticky-top bg-light">
                                    <tr>
                                        <th>排名</th>
                                        <th>城市</th>
                                        <th>推荐指数</th>
                                        <th>天气情况</th>
                                        <th>预计客流量</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for city in city_scores %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ city['城市'] }}</td>
                                        <td>
                                            {% if city['平均旅游评分'] >= 90 %}
                                            <span class="badge bg-success">强烈推荐</span>
                                            {% elif city['平均旅游评分'] >= 70 %}
                                            <span class="badge bg-info">推荐</span>
                                            {% elif city['平均旅游评分'] >= 50 %}
                                            <span class="badge bg-warning">一般</span>
                                            {% else %}
                                            <span class="badge bg-danger">不推荐</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ city['天气'] or '未知' }}</td>
                                        <td>{{ city['预计客流量'] or '未知' }}</td>
                                        <td>
                                            <a href="{{ url_for('tourism_decision_center.index', selected_city=city['城市'], travel_date=request.args.get('travel_date', ''), show_recommendations='true') }}"
                                                class="btn btn-sm btn-primary">选择</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="step-container" id="step-2">
        <div class="row">
            <!-- 步骤2: 景点推荐 -->
            <div class="col-md-6 offset-md-3">
                <div class="decision-step">
                    <i class="bi bi-star-fill step-icon"></i>
                    <h3 class="step-title">2. 景点推荐</h3>
                    <p class="step-description">基于天气情况和您的偏好，推荐最适合的景点</p>

                    <div class="card feature-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">景点推荐</h5>
                        </div>
                        <div class="card-body">
                            <form method="GET" action="{{ url_for('tourism_decision_center.index') }}" class="row g-3">
                                <input type="hidden" name="selected_city" value="{{ selected_city }}">
                                <input type="hidden" name="travel_date"
                                    value="{{ request.args.get('travel_date', '') }}">
                                <input type="hidden" name="show_recommendations" value="true">
                                <div class="col-md-6">
                                    <label for="attraction_type" class="form-label">景点类型偏好</label>
                                    <select class="form-select" id="attraction_type" name="attraction_type" multiple>
                                        <option value="博物馆" {% if '博物馆' in selected_attraction_types %}selected{% endif
                                            %}>博物馆</option>
                                        <option value="公园" {% if '公园' in selected_attraction_types %}selected{% endif
                                            %}>公园</option>
                                        <option value="风景区" {% if '风景区' in selected_attraction_types %}selected{% endif
                                            %}>风景区</option>
                                        <option value="历史古迹" {% if '历史古迹' in selected_attraction_types %}selected{%
                                            endif %}>历史古迹</option>
                                        <option value="自然景观" {% if '自然景观' in selected_attraction_types %}selected{%
                                            endif %}>自然景观</option>
                                        <option value="人文景观" {% if '人文景观' in selected_attraction_types %}selected{%
                                            endif %}>人文景观</option>
                                        <option value="主题公园" {% if '主题公园' in selected_attraction_types %}selected{%
                                            endif %}>主题公园</option>
                                        <option value="温泉" {% if '温泉' in selected_attraction_types %}selected{% endif
                                            %}>温泉</option>
                                        <option value="海滨" {% if '海滨' in selected_attraction_types %}selected{% endif
                                            %}>海滨</option>
                                    </select>
                                    <small class="form-text text-muted">按住Ctrl键可多选</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="min_rating" class="form-label">最低评分</label>
                                    <input type="range" class="form-range" id="min_rating" name="min_rating" min="0"
                                        max="5" step="0.5" value="{{ request.args.get('min_rating', 4.0) }}">
                                    <div class="d-flex justify-content-between">
                                        <span>0</span>
                                        <span>{{ request.args.get('min_rating', 4.0) }}</span>
                                        <span>5</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success">获取景点推荐</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 景点推荐结果 -->
                    {% if show_recommendations and recommendations %}
                    <div class="result-section mt-4">
                        <h5>推荐景点</h5>
                        <div class="row">
                            {% for rec in recommendations %}
                            <div class="col-12 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title">
                                                    {{ rec['城市'] }} - {{ rec['景点名称'] }}
                                                </h6>
                                                <div class="mt-1">
                                                    <span class="badge bg-secondary me-1">{{ rec['景点类型'] }}</span>
                                                    <span class="badge bg-success me-1">评分: {{ rec['评分'] }}</span>
                                                    <span class="badge bg-info me-1">最佳季节: {{ rec['最佳季节'] }}</span>
                                                    <span class="badge bg-warning">天气敏感度: {{ rec.get('天气敏感度', '中敏感度')
                                                        }}</span>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm btn-primary add-to-itinerary"
                                                data-attraction-id="{{ rec['城市'] }}-{{ rec['景点名称'] }}">添加到行程</button>
                                        </div>
                                        <p class="card-text mt-2 text-sm">{{ rec['简介截断'] }}</p>
                                        <div class="row text-xs text-muted">
                                            <div class="col-6">门票: {% if rec['门票价格'] == 0 %}免费{% else %}{{ rec['门票价格']
                                                }}元{%
                                                endif %}</div>
                                            <div class="col-6">游玩时长: {{ rec['推荐游玩时长'] or '未知' }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% elif show_recommendations %}
                    <div class="result-section mt-4 alert alert-info">
                        <p class="mb-0">根据您的选择，暂无符合条件的推荐景点。请尝试调整筛选条件。</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="step-container" id="step-3">
        <div class="row">
            <!-- 步骤3: 行程规划 -->
            <div class="col-md-6 offset-md-3">
                <div class="decision-step">
                    <i class="bi bi-calendar-check-fill step-icon"></i>
                    <h3 class="step-title">3. 行程规划</h3>
                    <p class="step-description">基于您选择的景点，生成最优的多日行程计划</p>

                    <!-- 已选景点行程 -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">我的行程景点</h5>
                        </div>
                        <div class="card-body">
                            <div id="itinerary-items-list"></div>
                            <div class="mt-3">
                                <small class="text-muted">提示：在景点推荐步骤中，点击"添加到行程"按钮将景点加入您的行程</small>
                            </div>
                        </div>
                    </div>

                    <!-- 行程生成 -->
                    <div class="card feature-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">行程生成</h5>
                        </div>
                        <div class="card-body">
                            <form id="itinerary-form" class="row g-3">
                                <div class="col-md-6">
                                    <label for="start_city" class="form-label">起点城市</label>
                                    <select id="start_city" class="form-select">
                                        {% for c in cities %}
                                        <option value="{{ c }}" {% if request.args.get('selected_city', '沈阳' )==c
                                            %}selected{% endif %}>{{ c }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="target_city" class="form-label">目标城市</label>
                                    <select id="target_city" class="form-select">
                                        {% for c in cities %}
                                        <option value="{{ c }}" {% if request.args.get('selected_city', '沈阳' )==c
                                            %}selected{% endif %}>{{ c }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="days" class="form-label">旅行天数</label>
                                    <input type="number" class="form-control" id="days" min="1" max="7" value="3">
                                </div>
                                <div class="col-12">
                                    <button type="button" id="generate-itinerary"
                                        class="btn btn-success w-100">生成行程</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 行程结果 -->
                    <div id="itinerary-result" class="result-section mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="step-container" id="step-4">
        <div class="row">
            <!-- 步骤4: 出行准备 -->
            <div class="col-md-6 offset-md-3">
                <div class="decision-step">
                    <i class="bi bi-suitcase-fill step-icon"></i>
                    <h3 class="step-title">4. 出行准备</h3>
                    <p class="step-description">获取详细的出行建议和风险评估，做好充分准备</p>

                    <div class="card feature-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">出行建议</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6>天气预警</h6>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> 请关注出行期间的天气变化，做好相应准备
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6>风险评估</h6>
                                <div class="alert alert-success">
                                    <i class="bi bi-shield-check"></i> 当前目的地风险等级：低风险
                                </div>
                            </div>

                            <div>
                                <h6>必备物品</h6>
                                <ul class="list-group">
                                    <li class="list-group-item"><i class="bi bi-check-circle text-success"></i> 身份证件
                                    </li>
                                    <li class="list-group-item"><i class="bi bi-check-circle text-success"></i> 手机充电器
                                    </li>
                                    <li class="list-group-item"><i class="bi bi-check-circle text-success"></i> 舒适的鞋子
                                    </li>
                                    <li class="list-group-item"><i class="bi bi-exclamation-circle text-warning"></i>
                                        雨具（根据天气情况）</li>
                                    <li class="list-group-item"><i class="bi bi-exclamation-circle text-warning"></i>
                                        防晒用品（根据天气情况）</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 客流量预测 -->
                    {% if selected_city %}
                    <div class="card mt-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">{{ selected_city }} 客流量预测</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <i class="bi bi-bar-chart-line display-4 text-info"></i>
                                <p class="mt-2">根据历史数据和天气预测，为您提供客流量高峰时段建议</p>
                                <button type="button" class="btn btn-info" data-city="{{ selected_city }}"
                                    id="trafficPredictionBtn">
                                    查看详细客流量预测
                                </button>
                            </div>
                            <!-- 客流量预测报告容器 - 初始隐藏 -->
                            <div id="trafficPredictionReport" class="mt-4" style="display: none;">
                                <!-- 这里将显示客流量预测报告 -->
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 整合功能入口 -->
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h5 class="card-title mb-0">更多功能</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-cloud-sun-rain-fill display-4 text-primary mb-3"></i>
                            <h6 class="card-title">天气预测</h6>
                            <p class="card-text text-sm">获取未来天气预报和旅游指数</p>
                            <a href="{{ url_for('prediction.index') }}" class="btn btn-primary btn-sm">进入</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-bar-chart-line display-4 text-primary mb-3"></i>
                            <h6 class="card-title">数据分析</h6>
                            <p class="card-text text-sm">查看旅游数据分析报告</p>
                            <a href="{{ url_for('visualizations.dashboard') }}" class="btn btn-primary btn-sm">进入</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导航按钮 - 固定在底部 -->
    <div class="fixed-bottom bg-white p-4 shadow-lg navigation-buttons">
        <button type="button" id="prev-btn" class="btn btn-secondary btn-lg" disabled>上一步</button>
        <button type="button" id="next-btn" class="btn btn-primary btn-lg">下一步</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 步骤管理
    let currentStep = 1;
    const totalSteps = 4;

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM内容加载完成，开始初始化...');

        // 初始化行程数据
        initItinerary();

        // 添加调试日志，检查selected_city值
        console.log('模板渲染的selected_city:', '{% if selected_city %}{{ selected_city }}{% else %}未选择{% endif %}');

        // 检查URL参数中是否包含selected_city，作为双重保险
        const urlParams = new URLSearchParams(window.location.search);
        const urlSelectedCity = urlParams.get('selected_city');
        console.log('URL参数中的selected_city:', urlSelectedCity);

        // 如果已经选择了城市（从模板或URL参数），直接跳转到步骤2
        const templateSelectedCity = '{% if selected_city %}{{ selected_city }}{% else %}{% endif %}';
        const hasSelectedCity = templateSelectedCity !== '' || urlSelectedCity;
        console.log('是否有选择城市:', hasSelectedCity, '模板值:', templateSelectedCity, 'URL值:', urlSelectedCity);

        if (hasSelectedCity) {
            console.log('检测到selected_city，跳转到步骤2');
            currentStep = 2;
            updateStepDisplay();
            console.log('步骤显示已更新，currentStep:', currentStep);
        } else {
            console.log('未检测到selected_city，停留在步骤1');
        }

        // 绑定导航按钮事件
        document.getElementById('prev-btn').addEventListener('click', goToPrevStep);
        document.getElementById('next-btn').addEventListener('click', goToNextStep);
        console.log('导航按钮事件已绑定');

        // 添加城市选择按钮事件监听，确保点击后能正确跳转
        console.log('开始绑定城市选择按钮事件');
        document.querySelectorAll('.btn-primary').forEach(btn => {
            if (btn.textContent.trim() === '选择') {
                btn.addEventListener('click', function (e) {
                    console.log('城市选择按钮被点击:', e.target.textContent.trim());
                    console.log('按钮href属性:', this.getAttribute('href'));
                    // 城市选择按钮是<a>标签，允许默认跳转行为
                    // 页面刷新后会通过页面加载时的逻辑跳转到步骤2
                    console.log('允许城市选择按钮的默认跳转');
                });
            }
        });
        console.log('城市选择按钮事件绑定完成');

        // 绑定"添加到行程"按钮事件
        document.querySelectorAll('.add-to-itinerary').forEach(btn => {
            btn.addEventListener('click', function () {
                const attractionCard = this.closest('.card');
                if (!attractionCard) return;

                // 提取景点数据
                const title = attractionCard.querySelector('.card-title').textContent.trim();
                const [city, name] = title.split(' - ');
                const type = attractionCard.querySelector('.badge.bg-secondary').textContent.trim();
                const rating = attractionCard.querySelector('.badge.bg-success').textContent.replace('评分: ', '').trim();
                const attractionId = this.getAttribute('data-attraction-id');

                // 构建景点数据对象
                const attractionData = {
                    id: attractionId,
                    city: city,
                    name: name,
                    type: type,
                    rating: rating
                };

                // 确认是否添加
                if (confirm(`确定要将"${name}"添加到您的行程中吗？`)) {
                    addToItinerary(attractionData);
                }
            });
        });
    });

    // 更新步骤显示
    function updateStepDisplay() {
        // 隐藏所有步骤
        document.querySelectorAll('.step-container').forEach(container => {
            container.classList.remove('active');
        });

        // 显示当前步骤
        document.getElementById(`step-${currentStep}`).classList.add('active');

        // 更新步骤指示器
        updateStepIndicators();

        // 更新按钮状态
        updateButtons();

        // 当切换到行程规划步骤时，更新行程显示
        if (currentStep === 3) {
            updateItineraryDisplay();
        }
    }

    // 更新步骤指示器
    function updateStepIndicators() {
        const circles = document.querySelectorAll('.flow-circle');
        circles.forEach((circle, index) => {
            const stepNum = index + 1;
            circle.classList.remove('active', 'completed');

            if (stepNum < currentStep) {
                circle.classList.add('completed');
            } else if (stepNum === currentStep) {
                circle.classList.add('active');
            }
        });
    }

    // 行程管理
    let itineraryItems = [];

    // 初始化行程数据 - 每次进入页面时重置行程，只保留当前会话数据
    function initItinerary() {
        // 重置行程数据，只保留当前会话的数据
        itineraryItems = [];
        // 更新行程显示
        updateItineraryDisplay();
    }

    // 重置行程数据 - 用于手动清除行程
    function resetItinerary() {
        itineraryItems = [];
        updateItineraryDisplay();
        alert('行程已重置');
    }

    // 保存行程数据 - 只在内存中保存，不持久化到localStorage
    function saveItinerary() {
        // 仅在内存中保存，不持久化，确保会话隔离
        console.log('行程数据已保存到当前会话:', itineraryItems);
    }

    // 添加景点到行程
    function addToItinerary(attractionData) {
        // 检查景点是否已在行程中，使用城市和名称的组合来识别，确保不会重复添加
        const existingIndex = itineraryItems.findIndex(item =>
            item.city === attractionData.city && item.name === attractionData.name
        );
        if (existingIndex !== -1) {
            alert('该景点已在您的行程中！');
            return;
        }

        // 添加到行程
        itineraryItems.push(attractionData);
        saveItinerary();
        updateItineraryDisplay();
        alert('景点已成功添加到行程！');
    }

    // 从行程中移除景点
    function removeFromItinerary(attractionId) {
        itineraryItems = itineraryItems.filter(item => item.id !== attractionId);
        saveItinerary();
        updateItineraryDisplay();
    }

    // 更新行程显示
    function updateItineraryDisplay() {
        const itineraryList = document.getElementById('itinerary-items-list');
        if (!itineraryList) return;

        if (itineraryItems.length === 0) {
            itineraryList.innerHTML = '<p class="text-center text-muted">您的行程中还没有添加任何景点</p>';
        } else {
            let html = '<ul class="list-group">';
            itineraryItems.forEach((item, index) => {
                html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${index + 1}. ${item.city} - ${item.name}</strong>
                        <div class="text-sm text-muted">${item.type} | 评分: ${item.rating}</div>
                    </div>
                    <button class="btn btn-sm btn-danger remove-from-itinerary" data-attraction-id="${item.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </li>
                `;
            });
            html += '</ul>';
            itineraryList.innerHTML = html;

            // 绑定移除按钮事件
            document.querySelectorAll('.remove-from-itinerary').forEach(btn => {
                btn.addEventListener('click', function () {
                    const attractionId = this.getAttribute('data-attraction-id');
                    if (confirm('确定要从行程中移除这个景点吗？')) {
                        removeFromItinerary(attractionId);
                    }
                });
            });
        }
    }

    // 更新按钮状态
    function updateButtons() {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // 更新上一步按钮
        prevBtn.disabled = currentStep === 1;

        // 更新下一步按钮
        nextBtn.disabled = currentStep === totalSteps;
        if (currentStep === totalSteps - 1) {
            nextBtn.textContent = '完成';
        } else {
            nextBtn.textContent = '下一步';
        }
    }

    // 上一步
    function goToPrevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepDisplay();
        }
    }

    // 下一步
    function goToNextStep() {
        if (currentStep < totalSteps) {
            currentStep++;
            updateStepDisplay();
        }
    }

    // 客流量预测功能 - 使用API获取数据
    document.addEventListener('DOMContentLoaded', function () {
        const reportContainer = document.getElementById('trafficPredictionReport');
        const btn = document.getElementById('trafficPredictionBtn');

        // 按钮点击事件
        btn?.addEventListener('click', async function () {
            const city = this.getAttribute('data-city');

            // 获取用户选择的出行日期和旅行天数
            const travelDate = document.getElementById('travel_date')?.value;
            const days = document.getElementById('days')?.value || 7;

            // 显示加载状态
            reportContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-info" role="status"><span class="visually-hidden">加载中...</span></div><p class="mt-2">正在加载客流量预测数据...</p></div>';
            reportContainer.style.display = 'block';

            // 切换按钮文本
            const originalText = this.textContent;
            this.textContent = '正在加载...';
            this.disabled = true;

            try {
                let weatherTableHtml = '';

                // 1. 获取天气预测数据
                const weatherResponse = await fetch('/api/weather/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        city: city,
                        days: parseInt(days),
                        start_date: travelDate
                    })
                });

                if (weatherResponse.ok) {
                    const weatherData = await weatherResponse.json();
                    const weatherPredictions = weatherData.predictions;

                    if (weatherPredictions && weatherPredictions.length > 0) {
                        // 2. 构建天气预测表格
                        const title = travelDate ? `${city} ${travelDate} 至 ${new Date(new Date(travelDate).setDate(new Date(travelDate).getDate() + parseInt(days) - 1)).toLocaleDateString('zh-CN')} 天气预测` : `${city} 未来 ${days} 天天气预测`;
                        weatherTableHtml = `
                            <h6 class="fw-bold mb-3">${title}</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>日期</th>
                                            <th>最高气温 (℃)</th>
                                            <th>最低气温 (℃)</th>
                                            <th>平均气温 (℃)</th>
                                            <th>旅游评分</th>
                                            <th>推荐指数</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        weatherPredictions.forEach(pred => {
                            // 格式化日期
                            const date = new Date(pred.日期);
                            const formattedDate = date.toLocaleDateString('zh-CN');

                            weatherTableHtml += `
                                <tr>
                                    <td>${formattedDate}</td>
                                    <td>${pred.最高气温 ? pred.最高气温.toFixed(1) : 'N/A'}</td>
                                    <td>${pred.最低气温 ? pred.最低气温.toFixed(1) : 'N/A'}</td>
                                    <td>${pred.平均气温 ? pred.平均气温.toFixed(1) : 'N/A'}</td>
                                    <td>${pred.旅游评分 || 'N/A'}</td>
                                    <td><span class="badge bg-${pred.推荐指数 === '强烈推荐' ? 'success' : pred.推荐指数 === '推荐' ? 'info' : pred.推荐指数 === '一般' ? 'warning' : 'danger'}">${pred.推荐指数 || 'N/A'}</span></td>
                                </tr>
                            `;
                        });

                        weatherTableHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        weatherTableHtml = `<div class="alert alert-info" role="alert">暂无天气预测数据</div>`;
                    }
                } else {
                    const errorData = await weatherResponse.json();
                    weatherTableHtml = `<div class="alert alert-info" role="alert">获取天气预测数据失败: ${errorData.message || '未知错误'}</div>`;
                }

                // 3. 简单的客流量预测模拟数据
                // 实际项目中，这里应该调用 /api/traffic_prediction/predict 端点
                // 但由于该端点需要景点名称和天气数据，我们先模拟一些数据
                const trafficHtml = `
                    <h6 class="fw-bold mb-3 mt-4">${city}客流量预测</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>时段</th>
                                    <th>预计客流量</th>
                                    <th>高峰状态</th>
                                    <th>建议</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>08:00-10:00</td>
                                    <td>1200人</td>
                                    <td><span class="badge bg-warning">中度高峰</span></td>
                                    <td>建议提前到达</td>
                                </tr>
                                <tr>
                                    <td>10:00-12:00</td>
                                    <td>2800人</td>
                                    <td><span class="badge bg-danger">高峰</span></td>
                                    <td>建议避开</td>
                                </tr>
                                <tr>
                                    <td>12:00-14:00</td>
                                    <td>1500人</td>
                                    <td><span class="badge bg-warning">中度高峰</span></td>
                                    <td>可以前往</td>
                                </tr>
                                <tr>
                                    <td>14:00-16:00</td>
                                    <td>2200人</td>
                                    <td><span class="badge bg-danger">高峰</span></td>
                                    <td>建议避开</td>
                                </tr>
                                <tr>
                                    <td>16:00-18:00</td>
                                    <td>1800人</td>
                                    <td><span class="badge bg-warning">中度高峰</span></td>
                                    <td>可以前往</td>
                                </tr>
                                <tr>
                                    <td>18:00以后</td>
                                    <td>800人</td>
                                    <td><span class="badge bg-success">低峰</span></td>
                                    <td>推荐前往</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;

                // 4. 整合所有内容
                reportContainer.innerHTML = weatherTableHtml + trafficHtml;

            } catch (error) {
                console.error('加载预测数据失败:', error);
                // 即使发生错误，也要显示客流量预测的模拟数据
                const trafficHtml = `
                    <h6 class="fw-bold mb-3">${city}客流量预测</h6>
                    <div class="alert alert-info" role="alert">获取天气数据时出错，但仍显示客流量预测参考</div>
                    <div class="table-responsive mt-3">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>时段</th>
                                    <th>预计客流量</th>
                                    <th>高峰状态</th>
                                    <th>建议</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>08:00-10:00</td>
                                    <td>1200人</td>
                                    <td><span class="badge bg-warning">中度高峰</span></td>
                                    <td>建议提前到达</td>
                                </tr>
                                <tr>
                                    <td>10:00-12:00</td>
                                    <td>2800人</td>
                                    <td><span class="badge bg-danger">高峰</span></td>
                                    <td>建议避开</td>
                                </tr>
                                <tr>
                                    <td>12:00-14:00</td>
                                    <td>1500人</td>
                                    <td><span class="badge bg-warning">中度高峰</span></td>
                                    <td>可以前往</td>
                                </tr>
                                <tr>
                                    <td>14:00-16:00</td>
                                    <td>2200人</td>
                                    <td><span class="badge bg-danger">高峰</span></td>
                                    <td>建议避开</td>
                                </tr>
                                <tr>
                                    <td>16:00-18:00</td>
                                    <td>1800人</td>
                                    <td><span class="badge bg-warning">中度高峰</span></td>
                                    <td>可以前往</td>
                                </tr>
                                <tr>
                                    <td>18:00以后</td>
                                    <td>800人</td>
                                    <td><span class="badge bg-success">低峰</span></td>
                                    <td>推荐前往</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                reportContainer.innerHTML = trafficHtml;
            } finally {
                // 恢复按钮状态
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });
    });

    // 生成行程按钮事件
    document.getElementById('generate-itinerary').addEventListener('click', function () {
        // 显示加载状态
        const resultDiv = document.getElementById('itinerary-result');
        resultDiv.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-success" role="status"><span class="visually-hidden">生成中...</span></div><p class="mt-2">正在生成最优行程...</p></div>';
        resultDiv.style.display = 'block';

        // 获取表单数据
        const startCity = document.getElementById('start_city').value;
        const targetCity = document.getElementById('target_city').value;
        const days = document.getElementById('days').value;

        // 检查是否有选择的景点
        if (itineraryItems.length === 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning">请先添加一些景点到行程中</div>';
            return;
        }

        // 构建请求数据，使用选择的景点
        const data = {
            start_city: startCity,
            target_city: targetCity, // 目标城市与起点城市可以不同
            days: parseInt(days),
            selected_attractions: itineraryItems, // 传递用户选择的景点
            preferences: {
                attraction_types: [], // 不再需要景点类型偏好
                min_rating: 4.0
            }
        };

        // 发送请求
        fetch('/path/optimize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    displayItinerary(result); // 传递完整的结果对象，包含 itinerary 和 map_html
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">行程生成失败: ' + result.message + '</div>';
                }
            })
            .catch(error => {
                console.error('生成行程时出错:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">生成行程时出错: ' + error.message + '</div>';
            });
    });

    // 显示行程结果
    function displayItinerary(result) {
        const resultDiv = document.getElementById('itinerary-result');
        const itinerary = result.itinerary;
        const budget = result.budget;
        const mapHtml = result.map_html || '';

        if (!itinerary || itinerary.length === 0) {
            resultDiv.innerHTML = '<p class="text-center text-muted">暂无行程数据</p>';
            return;
        }

        let html = '<h5>生成的行程计划</h5>';

        // 显示旅行费用预算
        if (budget && budget.total_cost) {
            html += `
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">旅行费用预算</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="text-primary">¥${budget.total_cost}</h4>
                                <small>总预算</small>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>费用类型</th>
                                            <th>金额(元)</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
            for (const [type, amount] of Object.entries(budget.breakdown)) {
                html += `
                        <tr>
                            <td>${type}</td>
                            <td>¥${amount}</td>
                        </tr>`;
            }
            html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h7>预算建议：</h7>
                        <ul class="list-unstyled">`;
            for (const suggestion of budget.suggestions) {
                html += `<li><i class="bi bi-info-circle text-primary"></i> ${suggestion}</li>`;
            }
            html += `
                                </ul>
                            </div>
                        </div>
                    </div>
                    `;
        }

        for (let i = 0; i < itinerary.length; i++) {
            const dayPlan = itinerary[i];
            const dayNum = dayPlan.day;
            const dayColors = ['blue', 'green', 'red', 'purple', 'orange', 'darkred', 'indigo'];
            const dayColor = dayColors[(dayNum - 1) % dayColors.length];

            html += `
            <div class="card mb-3">
                <div class="card-header bg-${dayColor} text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">第${dayNum}天行程</h6>
                        ${dayPlan.weather ? `<span class="weather-info">${dayPlan.weather.weather}，${dayPlan.weather.temperature}</span>` : ''}
                    </div>
                </div>
                <div class="card-body">
                    <h7>推荐景点：</h7>
                    <div class="mt-2">`;

            if (dayPlan.attractions && dayPlan.attractions.length > 0) {
                for (let j = 0; j < dayPlan.attractions.length; j++) {
                    const attraction = dayPlan.attractions[j];
                    const rating = attraction.rating || '暂无评分';
                    const price = attraction.price || 0;

                    html += `
                    <div class="attraction-item">
                        <div class="d-flex justify-content-between">
                            <strong>${j + 1}. ${attraction.name}</strong>
                            <span class="badge bg-secondary">${attraction.city}</span>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">
                                类型：${attraction.type} | 评分：${rating} | 价格：${price}元
                            </small>
                        </div>`;

                    // 如果有推荐参观时间
                    if (attraction.visit_time) {
                        html += `<div class="mt-1"><small class="text-primary">推荐参观时间：${attraction.visit_time}</small></div>`;
                    }

                    // 如果有出行信息，显示出行信息
                    if (attraction.travel_info && j > 0) {
                        html += `
                        <div class="mt-1 p-2 bg-light rounded">
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> 预计行程：${attraction.travel_info.distance || '0.0公里'}，${attraction.travel_info.transportation || '步行'}，约${attraction.travel_info.travel_time || '0分钟'}
                            </small>
                        </div>`;
                    }

                    // 风险评估
                    if (dayPlan.risk_assessment && dayPlan.risk_assessment[j]) {
                        const risk = dayPlan.risk_assessment[j];
                        let riskColor = 'text-success';
                        if (risk.risk_level === '中风险') riskColor = 'text-warning';
                        else if (risk.risk_level === '高风险') riskColor = 'text-danger';

                        html += `
                        <div class="mt-1">
                            <small class="${riskColor}">
                                风险等级：${risk.risk_level} | 建议：${risk.advice}
                            </small>
                        </div>`;
                    }

                    html += `
                    </div>`;
                }
            } else {
                html += `<p class="text-center text-muted">当天没有推荐景点</p>`;
            }

            html += `
                </div>`;

            // 显示当天的餐饮推荐
            if (dayPlan.recommended_dining && dayPlan.recommended_dining.length > 0) {
                html += `
                <div class="mt-3">
                    <h7>推荐餐饮：</h7>
                    <div class="row mt-2">`;
                for (const dining of dayPlan.recommended_dining) {
                    html += `
                    <div class="col-md-4 mb-2">
                        <div class="card card-sm">
                            <div class="card-body">
                                <h8>${dining.名称}</h8>
                                <div class="text-xs text-muted">${dining.类型}</div>
                                <div class="text-xs text-muted">地址：${dining.地址}</div>
                                <div class="text-xs text-muted">人均：¥${dining.人均价格 || '暂无数据'}</div>
                            </div>
                        </div>
                    </div>`;
                }
                html += `
                    </div>
                </div>
                `;
            }

            html += `
            </div>
            </div>`;
        }

        // 显示酒店推荐（只显示第一天的即可）
        if (itinerary[0].recommended_hotels && itinerary[0].recommended_hotels.length > 0) {
            html += `
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">推荐酒店</h6>
                </div>
                <div class="card-body">
                    <div class="row">`;
            for (const hotel of itinerary[0].recommended_hotels) {
                html += `
                <div class="col-md-4 mb-2">
                    <div class="card card-sm">
                        <div class="card-body">
                            <h8>${hotel.名称}</h8>
                            <div class="text-xs text-muted">${hotel.类型}</div>
                            <div class="text-xs text-muted">地址：${hotel.地址}</div>
                            <div class="text-xs text-muted">价格：¥${hotel.平均价格 || '暂无数据'}/晚</div>
                        </div>
                    </div>
                </div>`;
            }
            html += `
                    </div>
                </div>
            </div>
            `;
        }

        // 添加地图路线 - 调用地图生成API
        html += `
        <div class="card mb-3" id="map-card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">行程路线地图</h6>
            </div>
            <div class="card-body p-0">
                <div class="text-center py-4">
                    <div class="spinner-border text-info" role="status"><span class="visually-hidden">加载中...</span></div>
                    <p class="mt-2">正在生成行程地图...</p>
                </div>
            </div>
        </div>
        `;

        // 添加社交分享功能
        html += `
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">分享行程</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-center">
                    <button class="btn btn-sm btn-primary me-2" onclick="shareItinerary('wechat')">
                        <i class="bi bi-wechat"></i> 微信分享
                    </button>
                    <button class="btn btn-sm btn-info me-2" onclick="shareItinerary('weibo')">
                        <i class="bi bi-weibo"></i> 微博分享
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="shareItinerary('copy')">
                        <i class="bi bi-copy"></i> 复制链接
                    </button>
                </div>
            </div>
        </div>
        `;

        resultDiv.innerHTML = html;

        // 调用地图生成API，传递start_city和target_city
        fetch('/path/generate_map', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                itinerary: itinerary,
                start_city: result.start_city,
                target_city: result.target_city
            })
        })
            .then(response => response.json())
            .then(mapResult => {
                if (mapResult.success && mapResult.map_html) {
                    // 直接在页面中显示地图HTML，而不是使用iframe
                    const mapCard = document.getElementById('map-card');
                    const mapCardBody = mapCard.querySelector('.card-body');
                    mapCardBody.innerHTML = mapResult.map_html;
                    mapCardBody.style.padding = '0';

                    // 确保地图容器有足够的高度
                    const mapContainer = mapCardBody.querySelector('.leaflet-container') || mapCardBody.querySelector('#map-container');
                    if (mapContainer) {
                        mapContainer.style.height = '500px';
                        mapContainer.style.width = '100%';
                    }

                    // 地图渲染后，触发一次重绘，确保地图正确显示
                    setTimeout(() => {
                        // 检查是否存在Leaflet地图实例
                        if (window.L && mapCardBody.querySelector('.leaflet-container')) {
                            const mapElements = mapCardBody.querySelectorAll('.leaflet-container');
                            mapElements.forEach(element => {
                                try {
                                    // 强制浏览器重排
                                    element.offsetHeight;

                                    // 如果是Leaflet地图，调用invalidateSize
                                    // 尝试获取地图实例
                                    const mapInstance = window.L.Map.getMap(element);
                                    if (mapInstance) {
                                        mapInstance.invalidateSize();
                                        mapInstance.redraw();
                                    } else {
                                        // 如果无法直接获取地图实例，尝试重新初始化地图
                                        window.L.map(element);
                                    }
                                } catch (e) {
                                    console.error('地图重绘失败:', e);
                                }
                            });
                        }
                    }, 1000);
                } else {
                    console.error('地图生成失败:', mapResult.message);
                    const mapCard = document.getElementById('map-card');
                    const mapCardBody = mapCard.querySelector('.card-body');
                    mapCardBody.innerHTML = '<div class="alert alert-danger p-4 text-center">地图生成失败: ' + (mapResult.message || '未知错误') + '</div>';
                }
            })
            .catch(error => {
                console.error('生成地图时出错:', error);
                const mapCard = document.getElementById('map-card');
                const mapCardBody = mapCard.querySelector('.card-body');
                mapCardBody.innerHTML = '<div class="alert alert-danger p-4 text-center">生成地图时出错: ' + error.message + '</div>';
            });
    }

    // 社交分享功能
    function shareItinerary(platform) {
        const shareUrl = window.location.href;

        switch (platform) {
            case 'wechat':
                // 微信分享：生成带参数的链接，跳转到微信分享页面
                // 由于微信分享需要公众号配置，这里使用简单的链接生成方式
                const wechatShareUrl = `https://mp.weixin.qq.com/cgi-bin/loginpage?t=wxm2-login&lang=zh_CN&target=self`;
                window.open(wechatShareUrl, '_blank');
                break;
            case 'weibo':
                const weiboUrl = `http://service.weibo.com/share/share.php?url=${encodeURIComponent(shareUrl)}&title=我的辽宁旅游行程分享`;
                window.open(weiboUrl, '_blank');
                break;
            case 'copy':
                navigator.clipboard.writeText(shareUrl)
                    .then(() => {
                        alert('行程链接已复制到剪贴板！');
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动复制链接');
                    });
                break;
        }
    }
</script>
{% endblock %}