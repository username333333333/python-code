{% extends 'base.html' %}

{% block title %}所有城市天气预测{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">辽宁省所有城市天气预测</h1>

    <!-- 筛选条件 -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('prediction.all_cities_prediction') }}" class="row g-3">
                <div class="col-md-3">
                    <label for="city" class="form-label">选择城市</label>
                    <select class="form-select" id="city" name="city">
                        <option value="" {% if not selected_city %}selected{% endif %}>全部城市</option>
                        {% for c in cities %}
                        <option value="{{ c }}" {% if selected_city==c %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="days" class="form-label">预测天数</label>
                    <select class="form-select" id="days" name="days">
                        <option value="3" {% if selected_days==3 %}selected{% endif %}>3天</option>
                        <option value="7" {% if selected_days==7 %}selected{% endif %}>7天</option>
                        <option value="14" {% if selected_days==14 %}selected{% endif %}>14天</option>
                    </select>
                </div>
                <div class="col-md-3 align-self-end">
                    <button type="submit" class="btn btn-primary w-100">获取预测</button>
                </div>
                <div class="col-md-3 align-self-end">
                    <a href="{{ url_for('prediction.index') }}" class="btn btn-outline-primary w-100">返回单城市预测</a>
                </div>
            </form>
        </div>
    </div>



    <!-- 各城市预测结果 -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">各城市预测结果</h5>
        </div>
        <div class="card-body">
            {% if all_predictions %}
            <div class="accordion" id="cityPredictionsAccordion">
                {% for city, predictions in all_predictions.items() %}
                {% if not selected_city or city == selected_city %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ loop.index }}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ loop.index }}" aria-expanded="true"
                            aria-controls="collapse{{ loop.index }}">
                            {{ city }}未来{{ selected_days }}天预测
                        </button>
                    </h2>
                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse show"
                        aria-labelledby="heading{{ loop.index }}" data-bs-parent="#cityPredictionsAccordion">
                        <div class="accordion-body">
                            <!-- 天气预测表格 -->
                            <div class="table-responsive mb-4">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>日期</th>
                                            <th>天气状况</th>
                                            <th>最高气温 (℃)</th>
                                            <th>最低气温 (℃)</th>
                                            <th>平均气温 (℃)</th>
                                            <th>风力(白天)</th>
                                            <th>风力(夜间)</th>
                                            <th>旅游评分</th>
                                            <th>推荐指数</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for pred in predictions.to_dict('records') %}
                                        <tr
                                            class="{% if pred['推荐指数'] == '强烈推荐' %}table-success{% elif pred['推荐指数'] == '推荐' %}table-info{% elif pred['推荐指数'] == '一般' %}table-warning{% else %}table-danger{% endif %}">
                                            <td>{{ pred['日期'].strftime('%Y-%m-%d') }}</td>
                                            <td>
                                                {% set avg_temp = pred['平均气温'] | default(0) | round(1) %}
                                                {% set wind_day = pred['风力(白天)_数值'] | default(0) | round(1) %}
                                                
                                                {% if avg_temp > 25 %}
                                                    <i class="bi bi-sun text-warning" style="font-size: 1.5rem;"></i>
                                                {% elif avg_temp > 15 %}
                                                    {% if wind_day > 3 %}
                                                        <i class="bi bi-cloud-sun text-info" style="font-size: 1.5rem;"></i>
                                                    {% else %}
                                                        <i class="bi bi-cloud text-info" style="font-size: 1.5rem;"></i>
                                                    {% endif %}
                                                {% elif avg_temp > 5 %}
                                                    <i class="bi bi-cloud-drizzle text-primary" style="font-size: 1.5rem;"></i>
                                                {% else %}
                                                    <i class="bi bi-snow text-light" style="font-size: 1.5rem;"></i>
                                                {% endif %}
                                            </td>
                                            <td>{{ pred['最高气温'] | default(0) | round(1) }}</td>
                                            <td>{{ pred['最低气温'] | default(0) | round(1) }}</td>
                                            <td>{{ pred['平均气温'] | default(0) | round(1) }}</td>
                                            <td>{{ (pred['风力(白天)_数值'] | default(0) | round(1)) }} 级</td>
                                            <td>{{ (pred['风力(夜间)_数值'] | default(0) | round(1)) }} 级</td>
                                            <td>{{ pred['旅游评分'] }}</td>
                                            <td>{{ pred['推荐指数'] }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- 按日期显示的景点推荐 -->
                            <div class="mt-4">
                                <h6 class="fw-bold">每日推荐景点</h6>
                                {% if city_recommendations[city] %}
                                <div class="accordion" id="cityRecommendationsAccordion{{ city | replace('市', '') }}">
                                    {% for day_rec in city_recommendations[city] %}
                                    {% set inner_loop_index = loop.index %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header"
                                            id="recHeading{{ city | replace('市', '') }}{{ inner_loop_index }}">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#recCollapse{{ city | replace('市', '') }}{{ inner_loop_index }}"
                                                aria-expanded="false"
                                                aria-controls="recCollapse{{ city | replace('市', '') }}{{ inner_loop_index }}">
                                                {{ day_rec['date'] }} 推荐景点
                                            </button>
                                        </h2>
                                        <div id="recCollapse{{ city | replace('市', '') }}{{ inner_loop_index }}"
                                            class="accordion-collapse collapse"
                                            aria-labelledby="recHeading{{ city | replace('市', '') }}{{ inner_loop_index }}"
                                            data-bs-parent="#cityRecommendationsAccordion{{ city | replace('市', '') }}">
                                            <div class="accordion-body">
                                                {% if day_rec['recommendations'] %}
                                                <div class="row">
                                                    {% for rec in day_rec['recommendations'] %}
                                                    <div class="col-md-4 mb-3">
                                                        <div class="card h-100">
                                                            <div class="card-body">
                                                                <h7 class="fw-bold">{{ rec['景点名称'] }}</h7>
                                                                <p class="mb-1 text-muted small">{{ rec['景点类型'] }} | 评分:
                                                                    {{ rec['评分'] }}</p>
                                                                <p class="mb-1 text-sm">{{ rec['简介'][:100] }}...</p>
                                                                <div class="text-xs text-muted">
                                                                    最佳季节: {{ rec['最佳季节'] }} | 门票: {% if rec['门票价格'] == 0
                                                                    %}免费{% else %}{{ rec['门票价格'] }}元{% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% else %}
                                                <div class="text-center text-muted py-3">
                                                    暂无推荐景点
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-center text-muted py-3">
                                    暂无推荐景点
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info" role="alert">
                暂无预测数据，请稍后重试。
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 可以添加一些交互效果
    document.addEventListener('DOMContentLoaded', function () {
        console.log('所有城市天气预测页面加载完成');
    });
</script>
{% endblock %}