{% extends "base.html" %}
{% block title %}数据查询{% endblock %}

{% block scripts %}
<script>
    // 收藏查询功能
    const saveFavoriteBtn = document.getElementById('save-favorite');
    if (saveFavoriteBtn) {
        saveFavoriteBtn.addEventListener('click', function () {
            // 获取当前查询条件
            const formData = new FormData(document.querySelector('form'));
            const filters = {
                city: formData.get('city'),
                start_date: formData.get('start_date'),
                end_date: formData.get('end_date'),
                temp_min: formData.get('temp_min'),
                temp_max: formData.get('temp_max'),
                time_period: formData.get('time_period'),
                weather: formData.get('weather'),
                wind_dir: formData.get('wind_dir'),
                wind_lvl: formData.get('wind_lvl')
            };

            // 生成收藏名称
            let cityName = filters.city || '全部城市';
            let favoriteName = `${cityName} 天气查询`;

            // 发送收藏请求
            fetch('/user/favorites/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'query',
                    name: favoriteName,
                    content: filters
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('收藏成功！');
                    } else {
                        alert('收藏失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('收藏出错：', error);
                    alert('收藏失败，请稍后重试');
                });
        });
    }
</script>
{% endblock %}
{% block content %}
<h2 class="mb-4">天气数据查询</h2>

<!-- 查询表单 -->
<form method="get" class="row g-3 mb-4">
    <!-- 基本信息筛选 -->
    <div class="col-md-2">
        <label>城市</label>
        <select name="city" class="form-select">
            <option value="">全部</option>
            {% for c in options.cities %}
            <option value="{{ c }}" {% if filters.city==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- 日期范围筛选 -->
    <div class="col-md-2">
        <label>开始日期</label>
        <input type="date" name="start_date" class="form-control" value="{{ filters.start_date }}">
    </div>
    <div class="col-md-2">
        <label>结束日期</label>
        <input type="date" name="end_date" class="form-control" value="{{ filters.end_date }}">
    </div>

    <!-- 温度范围筛选 -->
    <div class="col-md-2">
        <label>最低气温 ≥</label>
        <input type="number" name="temp_min" class="form-control" value="{{ filters.temp_min }}" placeholder="℃">
    </div>
    <div class="col-md-2">
        <label>最高气温 ≤</label>
        <input type="number" name="temp_max" class="form-control" value="{{ filters.temp_max }}" placeholder="℃">
    </div>

    <!-- 天气状况筛选 -->
    <div class="col-md-2">
        <label>时间段</label>
        <select name="time_period" class="form-select">
            <option value="">全部</option>
            <option value="day" {% if filters.time_period=='day' %}selected{% endif %}>白天</option>
            <option value="night" {% if filters.time_period=='night' %}selected{% endif %}>夜间</option>
        </select>
    </div>
    <div class="col-md-2">
        <label>天气状况</label>
        <select name="weather" class="form-select">
            <option value="">全部</option>
            {% for w in options.weather_conditions %}
            <option value="{{ w }}" {% if filters.weather==w %}selected{% endif %}>{{ w }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- 风力风向筛选 -->
    <div class="col-md-2">
        <label>风向</label>
        <select name="wind_dir" class="form-select">
            <option value="">全部</option>
            {% for w in options.wind_directions %}
            <option value="{{ w }}" {% if filters.wind_dir==w %}selected{% endif %}>{{ w }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <label>风力</label>
        <select name="wind_lvl" class="form-select">
            <option value="">全部</option>
            {% for w in options.wind_levels %}
            <option value="{{ w }}" {% if filters.wind_lvl==w %}selected{% endif %}>{{ w }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- 查询按钮 -->
    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">查询</button>
        <button id="save-favorite" class="btn btn-success me-2" data-type="query">
            <i class="bi bi-bookmark-plus"></i> 收藏查询
        </button>
        <a href="{{ url_for('query_view.index') }}" class="btn btn-secondary">重置</a>
    </div>
</form>

<!-- 数据表格 -->
<table class="table table-bordered table-striped table-hover table-sm">
    <thead class="table-light">
        <tr>
            <th>城市</th>
            <th>日期</th>
            <th>最高气温</th>
            <th>最低气温</th>
            <th>天气状况(白天)</th>
            <th>天气状况(夜间)</th>
            <th>风向(白天)</th>
            <th>风力(白天)</th>
            <th>风向(夜间)</th>
            <th>风力(夜间)</th>
        </tr>
    </thead>
    <tbody>
        {% for row in data %}
        <tr>
            <td>{{ row['城市'] }}</td>
            <td>{{ row['日期'] }}</td>
            <td>{{ row['最高气温'] }}</td>
            <td>{{ row['最低气温'] }}</td>
            <td>{{ row['天气状况(白天)'] }}</td>
            <td>{{ row['天气状况(夜间)'] }}</td>
            <td>{{ row['风向(白天)'] }}</td>
            <td>{{ row['风力(白天)_数值'] }}级</td>
            <td>{{ row['风向(夜间)'] }}</td>
            <td>{{ row['风力(夜间)_数值'] }}级</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ✅ 分页区域 -->
<div class="d-flex justify-content-between align-items-center mt-4">
    <div>
        共 {{ pagination.total_items }} 条记录，当前第 {{ pagination.page }} 页 / 共 {{ pagination.total_pages }} 页
    </div>

    <form method="get" class="d-flex align-items-center">
        <!-- ✅ 保留所有非空筛选参数 -->
        {% for key, value in filters.items() %}
        {% if key != 'page' and value %}
        <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endif %}
        {% endfor %}

        <nav>
            <ul class="pagination mb-0">
                <li class="page-item {% if pagination.page == 1 %}disabled{% endif %}">
                    <button class="page-link" type="submit" name="page" value="1">&laquo;</button>
                </li>
                <li class="page-item {% if pagination.page == 1 %}disabled{% endif %}">
                    <button class="page-link" type="submit" name="page"
                        value="{{ pagination.page - 1 }}">&lsaquo;</button>
                </li>

                {% for p in range(max(1, pagination.page - 2), min(pagination.total_pages + 1, pagination.page + 3)) %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                    <button class="page-link" type="submit" name="page" value="{{ p }}">{{ p }}</button>
                </li>
                {% endfor %}

                <li class="page-item {% if pagination.page == pagination.total_pages %}disabled{% endif %}">
                    <button class="page-link" type="submit" name="page"
                        value="{{ pagination.page + 1 }}">&rsaquo;</button>
                </li>
                <li class="page-item {% if pagination.page == pagination.total_pages %}disabled{% endif %}">
                    <button class="page-link" type="submit" name="page"
                        value="{{ pagination.total_pages }}">&raquo;</button>
                </li>
            </ul>
        </nav>

        <div class="ms-2">
            <input type="number" name="page" min="1" max="{{ pagination.total_pages }}"
                class="form-control form-control-sm d-inline-block" style="width: 80px;" placeholder="跳转页">
        </div>
        <button class="btn btn-sm btn-outline-secondary ms-2" type="submit">跳转</button>
    </form>
</div>

{% endblock %}