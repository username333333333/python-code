{% extends 'base.html' %}

{% block title %}旅游推荐{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">辽宁省旅游出行推荐</h1>
    
    <!-- 筛选条件 -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('recommendation.index') }}" class="row g-3">
                <!-- 搜索框 -->
                <div class="col-md-6">
                    <label for="search_keyword" class="form-label">景点搜索</label>
                    <input type="text" class="form-control" id="search_keyword" name="search_keyword" placeholder="输入景点名称或关键词" value="{{ request.args.get('search_keyword', '') }}">
                </div>
                
                <div class="col-md-3">
                    <label for="city" class="form-label">选择城市</label>
                    <select class="form-select" id="city" name="city">
                        <option value="" {% if selected_city == "" %}selected{% endif %}>全部城市</option>
                        {% for c in cities %}
                        <option value="{{ c }}" {% if selected_city == c %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="type" class="form-label">推荐类型</label>
                    <select class="form-select" id="type" name="type" onchange="toggleFilters()">
                        <option value="weather" {% if selected_type == "weather" %}selected{% endif %}>基于天气</option>
                        <option value="season" {% if selected_type == "season" %}selected{% endif %}>基于季节</option>
                        <option value="type" {% if selected_type == "type" %}selected{% endif %}>基于景点类型</option>
                    </select>
                </div>
                
                <!-- 基于天气的日期选择 -->
                <div class="col-md-3" id="date_filter" {% if selected_type != "weather" %}style="display: none;"{% endif %}>
                    <label for="date" class="form-label">选择日期</label>
                    <input type="date" class="form-control" id="date" name="date" value="{{ selected_date }}">
                </div>
                
                <!-- 基于季节的季节选择 -->
                <div class="col-md-3" id="season_filter" {% if selected_type != "season" %}style="display: none;"{% endif %}>
                    <label for="season" class="form-label">选择季节</label>
                    <select class="form-select" id="season" name="season">
                        {% for s in seasons %}
                        <option value="{{ s }}" {% if selected_season == s %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- 基于景点类型的类型选择 -->
                <div class="col-md-3" id="attraction_type_filter" {% if selected_type != "type" %}style="display: none;"{% endif %}>
                    <label for="attraction_type" class="form-label">景点类型</label>
                    <select class="form-select" id="attraction_type" name="attraction_type">
                        {% for t in attraction_types %}
                        <option value="{{ t }}" {% if selected_attraction_type == t %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="top_n" class="form-label">推荐数量</label>
                    <select class="form-select" id="top_n" name="top_n">
                        <option value="5" {% if selected_top_n == 5 %}selected{% endif %}>5个</option>
                        <option value="10" {% if selected_top_n == 10 %}selected{% endif %}>10个</option>
                        <option value="15" {% if selected_top_n == 15 %}selected{% endif %}>15个</option>
                    </select>
                </div>
                
                <!-- 新增筛选条件：最低评分 -->
                <div class="col-md-3">
                    <label for="min_rating" class="form-label">最低评分 (<span id="min_rating_value">{{ selected_min_rating }}</span>)</label>
                    <input type="range" class="form-range" id="min_rating" name="min_rating" min="0" max="5" step="0.5" value="{{ selected_min_rating }}">
                </div>
                
                <!-- 新增筛选条件：最高门票价格 -->
                <div class="col-md-3">
                    <label for="max_price" class="form-label">最高门票价格 (元)</label>
                    <input type="number" class="form-control" id="max_price" name="max_price" placeholder="不限制" {% if selected_max_price %}value="{{ selected_max_price }}"{% endif %}>
                </div>
                
                <!-- 新增筛选条件：免费/付费 -->
                <div class="col-md-3">
                    <label class="form-label">门票类型</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_free" id="is_free_all" value="" {% if selected_is_free is none %}checked{% endif %}>
                            <label class="form-check-label" for="is_free_all">
                                全部
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_free" id="is_free_true" value="true" {% if selected_is_free == true %}checked{% endif %}>
                            <label class="form-check-label" for="is_free_true">
                                免费
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_free" id="is_free_false" value="false" {% if selected_is_free == false %}checked{% endif %}>
                            <label class="form-check-label" for="is_free_false">
                                付费
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 新增筛选条件：最佳季节 -->
                <div class="col-md-3">
                    <label class="form-label">最佳季节</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for s in seasons %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="selected_seasons" id="season_{{ s }}" value="{{ s }}" {% if s in selected_selected_seasons %}checked{% endif %}>
                            <label class="form-check-label" for="season_{{ s }}">
                                {{ s }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="col-md-3 align-self-end">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">获取推荐</button>
                        <button type="button" class="btn btn-success" id="save-favorite" data-type="recommendation">
                            <i class="bi bi-bookmark-plus"></i> 收藏推荐
                        </button>
                        <button type="button" class="btn btn-secondary" id="reset_filters">重置筛选</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 城市旅游评分排名 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">城市旅游评分排名</h5>
        </div>
        <div class="card-body">
            {% if city_scores %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>城市</th>
                            <th>平均旅游评分</th>
                            <th>推荐指数</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for city in city_scores %}
                        <tr>
                            <th scope="row">{{ loop.index }}</th>
                            <td>{{ city['城市'] }}</td>
                            <td>{{ city['平均旅游评分'] }}</td>
                            <td>
                                {% if city['平均旅游评分'] >= 90 %}
                                <span class="badge bg-success">强烈推荐</span>
                                {% elif city['平均旅游评分'] >= 70 %}
                                <span class="badge bg-info">推荐</span>
                                {% elif city['平均旅游评分'] >= 50 %}
                                <span class="badge bg-warning">一般</span>
                                {% else %}
                                <span class="badge bg-danger">不推荐</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info" role="alert">
                暂无城市评分数据，请稍后重试。
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 推荐结果 -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">旅游推荐结果</h5>
        </div>
        <div class="card-body">
            {% if recommendations %}
                <div class="row">
                    {% for rec in recommendations %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 hover-shadow">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="card-title mb-0">{{ rec['城市'] }} - {{ rec['景点名称'] }}</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <span class="badge bg-secondary me-1">{{ rec['景点类型'] }}</span>
                                        <span class="badge bg-success me-1">评分: {{ rec['评分'] }}</span>
                                        <span class="badge bg-info">最佳季节: {{ rec['最佳季节'] }}</span>
                                    </div>
                                    <p class="mb-2">{{ rec['简介截断'] }}</p>
                                    <div class="row text-sm text-muted">
                                        <div class="col-6">门票: {% if rec['门票价格'] == 0 %}免费{% else %}{{ rec['门票价格'] }}元{% endif %}</div>
                                        <div class="col-6">游玩时长: {{ rec['推荐游玩时长'] or '未知' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info" role="alert">
                    暂无推荐数据，请调整筛选条件后重试。
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 收藏推荐功能
    const saveFavoriteBtn = document.getElementById('save-favorite');
    if (saveFavoriteBtn) {
        saveFavoriteBtn.addEventListener('click', function() {
            // 获取当前推荐条件
            const formData = new FormData(document.querySelector('form'));
            const filters = {
                search_keyword: formData.get('search_keyword'),
                city: formData.get('city'),
                type: formData.get('type'),
                date: formData.get('date'),
                season: formData.get('season'),
                attraction_type: formData.get('attraction_type'),
                top_n: formData.get('top_n'),
                min_rating: formData.get('min_rating'),
                max_price: formData.get('max_price'),
                is_free: formData.get('is_free'),
                selected_seasons: formData.getAll('selected_seasons')
            };
            
            // 获取推荐结果
            const recommendations = [];
            const recommendationCards = document.querySelectorAll('.card.h-100.hover-shadow');
            recommendationCards.forEach(card => {
                const header = card.querySelector('.card-header');
                const cityName = header.textContent.split(' - ')[0];
                const attractionName = header.textContent.split(' - ')[1];
                
                const badges = card.querySelectorAll('.badge');
                let attractionType = '';
                let rating = '';
                let bestSeason = '';
                badges.forEach(badge => {
                    if (badge.classList.contains('bg-secondary')) {
                        attractionType = badge.textContent;
                    } else if (badge.classList.contains('bg-success')) {
                        rating = badge.textContent.split(': ')[1];
                    } else if (badge.classList.contains('bg-info')) {
                        bestSeason = badge.textContent.split(': ')[1];
                    }
                });
                
                const intro = card.querySelector('.card-body p.mb-2').textContent;
                
                const infoDivs = card.querySelectorAll('.card-body .row.text-sm.text-muted div');
                let ticketPrice = 0;
                let playTime = '未知';
                infoDivs.forEach(div => {
                    if (div.textContent.startsWith('门票:')) {
                        const priceText = div.textContent.split(': ')[1];
                        if (priceText === '免费') {
                            ticketPrice = 0;
                        } else {
                            ticketPrice = parseFloat(priceText);
                        }
                    } else if (div.textContent.startsWith('游玩时长:')) {
                        playTime = div.textContent.split(': ')[1];
                    }
                });
                
                recommendations.push({
                    城市: cityName,
                    景点名称: attractionName,
                    景点类型: attractionType,
                    评分: parseFloat(rating),
                    最佳季节: bestSeason,
                    简介: intro,
                    门票价格: ticketPrice,
                    推荐游玩时长: playTime
                });
            });
            
            // 生成收藏名称
            let cityName = filters.city || '全部城市';
            let favoriteName = `${cityName} 旅游推荐`;
            
            // 准备收藏内容，包含筛选条件和推荐结果
            const content = {
                filters: filters,
                recommendations: recommendations
            };
            
            // 发送收藏请求
            fetch('/user/favorites/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'recommendation',
                    name: favoriteName,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('收藏成功！');
                } else {
                    alert('收藏失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('收藏出错：', error);
                alert('收藏失败，请稍后重试');
            });
        });
    }
    
    // 切换筛选条件显示
    function toggleFilters() {
        var type = document.getElementById('type').value;
        
        // 隐藏所有筛选条件
        document.getElementById('date_filter').style.display = 'none';
        document.getElementById('season_filter').style.display = 'none';
        document.getElementById('attraction_type_filter').style.display = 'none';
        
        // 显示对应的筛选条件
        if (type == 'weather') {
            document.getElementById('date_filter').style.display = 'block';
        } else if (type == 'season') {
            document.getElementById('season_filter').style.display = 'block';
        } else if (type == 'type') {
            document.getElementById('attraction_type_filter').style.display = 'block';
        }
    }
    
    // 实时更新最低评分显示
    function updateMinRatingDisplay() {
        var slider = document.getElementById('min_rating');
        var valueDisplay = document.getElementById('min_rating_value');
        valueDisplay.textContent = slider.value;
    }
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        toggleFilters();
        
        // 添加最低评分滑块的实时更新
        var minRatingSlider = document.getElementById('min_rating');
        if (minRatingSlider) {
            minRatingSlider.addEventListener('input', updateMinRatingDisplay);
            // 初始更新一次
            updateMinRatingDisplay();
        }
        
        // 添加重置筛选功能
        var resetButton = document.getElementById('reset_filters');
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                // 重置所有筛选条件
                
                // 重置下拉选择框
                document.getElementById('city').value = '';
                document.getElementById('type').value = 'weather';
                document.getElementById('date').value = '';
                document.getElementById('season').value = '';
                document.getElementById('attraction_type').value = '';
                document.getElementById('top_n').value = '5';
                
                // 重置最低评分滑块
                document.getElementById('min_rating').value = '0';
                document.getElementById('min_rating_value').textContent = '0';
                
                // 重置价格范围
                document.getElementById('max_price').value = '';
                
                // 重置门票类型单选框
                document.getElementById('is_free_all').checked = true;
                
                // 重置季节复选框
                var seasonCheckboxes = document.querySelectorAll('input[name="selected_seasons"]');
                seasonCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                
                // 重置搜索关键词
                document.getElementById('search_keyword').value = '';
                
                // 切换筛选条件显示
                toggleFilters();
            });
        }
    });
</script>
{% endblock %}