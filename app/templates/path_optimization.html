{% extends "base.html" %}

{% block title %}路径优化{% endblock %}

{% block styles %}
<style>
    #map-container {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .itinerary-card {
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .itinerary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .day-badge {
        font-size: 1.2rem;
        font-weight: bold;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
    }

    .attraction-item {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .attraction-item:hover {
        background: #e9ecef;
    }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-primary:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    label {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div id="app" class="container-fluid p-4">
    <h1 class="mb-4">辽宁省智慧旅游路径优化</h1>

    <div class="row">
        <!-- 左侧控制面板 -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">路径设置</h5>
                </div>
                <div class="card-body">
                    <form id="path-form">
                        <div class="form-group">
                            <label for="start-city">起点城市</label>
                            <select id="start-city" class="form-select">
                                <option value="沈阳">沈阳</option>
                                <option value="大连">大连</option>
                                <option value="丹东">丹东</option>
                                <option value="鞍山">鞍山</option>
                                <option value="抚顺">抚顺</option>
                                <option value="本溪">本溪</option>
                                <option value="锦州">锦州</option>
                                <option value="营口">营口</option>
                                <option value="阜新">阜新</option>
                                <option value="辽阳">辽阳</option>
                                <option value="盘锦">盘锦</option>
                                <option value="铁岭">铁岭</option>
                                <option value="朝阳">朝阳</option>
                                <option value="葫芦岛">葫芦岛</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="target-city">目标城市</label>
                            <select id="target-city" class="form-select">
                                <option value="沈阳">沈阳</option>
                                <option value="大连">大连</option>
                                <option value="丹东">丹东</option>
                                <option value="鞍山">鞍山</option>
                                <option value="抚顺">抚顺</option>
                                <option value="本溪">本溪</option>
                                <option value="锦州">锦州</option>
                                <option value="营口">营口</option>
                                <option value="阜新">阜新</option>
                                <option value="辽阳">辽阳</option>
                                <option value="盘锦">盘锦</option>
                                <option value="铁岭">铁岭</option>
                                <option value="朝阳">朝阳</option>
                                <option value="葫芦岛">葫芦岛</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="days">旅行天数</label>
                            <input type="number" id="days" class="form-control" min="1" max="7" value="3">
                        </div>

                        <div class="form-group">
                            <label for="attraction-types">景点类型偏好</label>
                            <select id="attraction-types" class="form-select" multiple>
                                <option value="博物馆" selected>博物馆</option>
                                <option value="公园" selected>公园</option>
                                <option value="风景区" selected>风景区</option>
                                <option value="历史古迹">历史古迹</option>
                                <option value="自然景观">自然景观</option>
                                <option value="人文景观">人文景观</option>
                                <option value="主题公园">主题公园</option>
                                <option value="温泉">温泉</option>
                                <option value="海滨">海滨</option>
                            </select>
                            <small class="form-text text-muted">按住Ctrl键可多选</small>
                        </div>

                        <div class="form-group">
                            <label for="min-rating">最低评分</label>
                            <input type="range" id="min-rating" class="form-range" min="0" max="5" step="0.5" value="4">
                            <div class="d-flex justify-content-between">
                                <span>0</span>
                                <span><span id="rating-value">4.0</span></span>
                                <span>5</span>
                            </div>
                        </div>

                        <button type="button" id="generate-path-btn" class="btn btn-primary w-100">
                            <i class="bi bi-route"></i> 生成闭环路径
                        </button>
                        <button id="save-itinerary" class="btn btn-success w-100 mt-2" style="display: none;">
                            <i class="bi bi-save"></i> 保存行程
                        </button>
                    </form>
                </div>
            </div>

            <!-- 天气调整选项 -->
            <div class="card mb-4" id="weather-section" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">天气调整</h5>
                </div>
                <div class="card-body">
                    <p>选择未来天气预测，系统将根据天气优化行程：</p>
                    <div id="weather-forecast">
                        <!-- 天气选项将通过JS动态生成 -->
                    </div>
                    <button id="adjust-weather" class="btn btn-info w-100 mt-2">
                        <i class="bi bi-cloud-sun-rain"></i> 根据天气调整行程
                    </button>
                </div>
            </div>

            <!-- 历史行程 -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> 历史行程
                    </h5>
                </div>
                <div class="card-body">
                    <div id="history-itineraries">
                        <p class="text-center text-muted">暂无历史行程</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧结果展示 -->
        <div class="col-md-8">
            <!-- 加载状态 -->
            <div class="loading" id="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在生成最优路径...</p>
            </div>

            <!-- 地图展示 -->
            <div class="card mb-4" id="map-card" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">路径地图</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map-container"></div>
                </div>
            </div>

            <!-- 行程结果 -->
            <div id="itinerary-result" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    console.log('Vue 应用开始初始化');

    // Vue 应用
    const { createApp } = Vue;

    const app = createApp({
        data() {
            return {
                itinerary: null,
                mapHtml: null,
                isLoading: false
            };
        },
        methods: {
            async loadHistoryItineraries() {
                """加载历史行程"""
                try {
                    const response = await fetch('/path/history', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.displayHistoryItineraries(result.itineraries);
                        }
                    }
                } catch (error) {
                    console.error('加载历史行程失败:', error);
                }
            },

            displayHistoryItineraries(itineraries) {
                """显示历史行程列表"""
                const container = document.getElementById('history-itineraries');

                if (!itineraries || itineraries.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">暂无历史行程</p>';
                    return;
                }

                container.innerHTML = '';

                itineraries.forEach(itinerary => {
                    const card = document.createElement('div');
                    card.className = 'card mb-2';
                    card.innerHTML = "\n                        <div class=\"card-body p-3\">\n                            <div class=\"d-flex justify-content-between align-items-center\">\n                                <h6 class=\"mb-0\">\n                                    <i class=\"bi bi-calendar\"></i> " + itinerary.start_city + " → " + itinerary.start_city + "\n                                </h6>\n                                <span class=\"badge bg-primary\">" + itinerary.days + "天</span>\n                            </div>\n                            <div class=\"mt-1 text-sm\">\n                                <p class=\"mb-0\">\n                                    <i class=\"bi bi-clock\"></i> 创建时间: " + new Date(itinerary.created_at).toLocaleString() + "\n                                </p>\n                                <p class=\"mb-0\">\n                                    <i class=\"bi bi-map\"></i> 状态: " + itinerary.status + "\n                                </p>\n                            </div>\n                            <div class=\"mt-2\">\n                                <button class=\"btn btn-sm btn-outline-primary mr-1\" onclick=\"app.loadItinerary(" + itinerary.id + ")\">\n                                    <i class=\"bi bi-eye\"></i> 查看\n                                </button>\n                                <button class=\"btn btn-sm btn-outline-danger\" onclick=\"app.deleteItinerary(" + itinerary.id + ")\">\n                                    <i class=\"bi bi-trash\"></i> 删除\n                                </button>\n                            </div>\n                        </div>\n                    ";
                    container.appendChild(card);
                });
            },

            async saveItinerary() {
                """保存当前行程到数据库"""
                if (!this.itinerary) {
                    alert('没有可保存的行程');
                    return;
                }

                try {
                    // 获取表单数据
                    const startCity = document.getElementById('start-city').value;
                    const targetCity = document.getElementById('target-city').value;
                    const days = parseInt(document.getElementById('days').value);
                    const attractionTypes = Array.from(
                        document.getElementById('attraction-types').selectedOptions
                    ).map(option => option.value);
                    const minRating = parseFloat(document.getElementById('min-rating').value);

                    const data = {
                        start_city: startCity,
                        target_city: targetCity,
                        days: days,
                        start_date: new Date().toISOString().split('T')[0],
                        is_closed_loop: true,
                        preferences: {
                            attraction_types: attractionTypes,
                            min_rating: minRating
                        },
                        itinerary: this.itinerary
                    };

                    const response = await fetch('/path/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            alert('行程保存成功！');
                            this.loadHistoryItineraries(); // 重新加载历史行程
                        } else {
                            alert('行程保存失败: ' + result.message);
                        }
                    }
                } catch (error) {
                    console.error('保存行程失败:', error);
                    alert('保存行程时出现错误，请稍后重试');
                }
            },

            async generatePath() {
                console.log('generatePath函数被调用');

                this.isLoading = true;
                this.hideAll();
                this.showLoading();

                try {
                    // 获取表单数据
                    console.log('开始获取表单数据');
                    const startCityEl = document.getElementById('start-city');
                    const targetCityEl = document.getElementById('target-city');
                    const daysEl = document.getElementById('days');
                    const attractionTypesEl = document.getElementById('attraction-types');
                    const minRatingEl = document.getElementById('min-rating');

                    console.log('表单元素:', {
                        startCityEl: startCityEl ? '存在' : '不存在',
                        targetCityEl: targetCityEl ? '存在' : '不存在',
                        daysEl: daysEl ? '存在' : '不存在',
                        attractionTypesEl: attractionTypesEl ? '存在' : '不存在',
                        minRatingEl: minRatingEl ? '存在' : '不存在'
                    });

                    if (!startCityEl || !targetCityEl || !daysEl || !attractionTypesEl || !minRatingEl) {
                        throw new Error('缺少必要的表单元素');
                    }

                    const startCity = startCityEl.value;
                    const targetCity = targetCityEl.value;
                    const days = parseInt(daysEl.value);
                    const attractionTypes = Array.from(
                        attractionTypesEl.selectedOptions
                    ).map(option => option.value);
                    const minRating = parseFloat(minRatingEl.value);

                    console.log('表单数据获取成功:', {
                        startCity,
                        targetCity,
                        days,
                        attractionTypes,
                        minRating
                    });

                    // 构建请求数据
                    const data = {
                        start_city: startCity,
                        target_city: targetCity,
                        days: days,
                        preferences: {
                            attraction_types: attractionTypes,
                            min_rating: minRating
                        }
                    };

                    console.log('请求数据构建成功:', data);

                    // 发送请求，设置超时时间为30秒
                    console.log('开始发送请求到/path/calculate');
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);

                    // 添加更多日志，跟踪fetch请求的发送
                    console.log('准备发送fetch请求，URL:', '/path/calculate');
                    console.log('请求头:', {
                        'Content-Type': 'application/json'
                    });
                    console.log('请求体:', JSON.stringify(data));

                    const response = await fetch('/path/calculate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    console.log('请求成功返回，状态码:', response.status);
                    console.log('响应头:', Object.fromEntries(response.headers.entries()));

                    // 尝试获取响应体
                    const responseText = await response.text();
                    console.log('响应文本:', responseText);

                    // 尝试解析响应体为JSON
                    let result;
                    try {
                        result = JSON.parse(responseText);
                        console.log('响应JSON解析成功:', result);
                    } catch (e) {
                        console.error('响应JSON解析失败:', e);
                        throw new Error('响应JSON解析失败: ' + e.message);
                    }

                    if (!response.ok) {
                        throw new Error('HTTP错误! 状态码: ' + response.status);
                    }

                    // 已经在前面解析过响应体，直接使用result变量
                    console.log('响应数据:', result);

                    if (result.success) {
                        console.log('路径生成成功，开始处理结果');
                        this.itinerary = result.itinerary;
                        // 立即显示行程信息，不等待地图生成
                        this.displayItinerary();
                        this.showWeatherSection();
                        // 显示保存行程按钮
                        document.getElementById('save-itinerary').style.display = 'block';
                        // 异步生成地图，不阻塞行程显示
                        this.generateMap().catch(error => {
                            console.error('地图生成失败:', error);
                            // 地图生成失败不影响行程显示
                        });
                        console.log('结果处理完成');
                    } else {
                        alert('路径生成失败: ' + result.message);
                        console.error('路径生成失败:', result.message);
                    }
                } catch (error) {
                    console.error('生成路径时出现错误:', error);
                    if (error.name === 'AbortError') {
                        alert('生成路径超时，请尝试减少旅行天数或景点类型偏好，稍后重试');
                    } else {
                        alert('生成路径时出现错误，请稍后重试: ' + error.message);
                    }
                } finally {
                    this.isLoading = false;
                    this.hideLoading();
                    console.log('生成路径流程结束');
                }
            },

            async generateMap() {
                if (!this.itinerary) {
                    console.warn('没有行程数据，无法生成地图');
                    return;
                }

                try {
                    // 显示地图加载状态
                    const mapCard = document.getElementById('map-card');
                    const mapContainer = document.getElementById('map-container');
                    mapCard.style.display = 'block';
                    mapContainer.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 600px; font-size: 18px; color: #666;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div> 正在生成地图...</div>';

                    // 发送请求，设置超时时间为30秒
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);

                    console.log('开始发送请求到/path/generate_map');
                    console.log('请求数据:', JSON.stringify({ itinerary: this.itinerary }));

                    const response = await fetch('/path/generate_map', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ itinerary: this.itinerary }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    console.log('地图生成请求返回，状态码:', response.status);

                    // 尝试获取响应文本
                    const responseText = await response.text();
                    console.log('地图生成响应文本:', responseText);

                    // 尝试解析响应为JSON
                    let result;
                    try {
                        result = JSON.parse(responseText);
                        console.log('地图生成响应JSON解析成功:', result);
                    } catch (e) {
                        console.error('地图生成响应JSON解析失败:', e);
                        throw new Error('地图生成响应JSON解析失败: ' + e.message);
                    }

                    if (!response.ok) {
                        throw new Error('HTTP错误! 状态码: ' + response.status);
                    }

                    if (result.success) {
                        this.mapHtml = result.map_html;
                        this.displayMap();
                        // 触发地图重绘，确保地图正确显示
                        this.triggerMapRedraw();
                    } else {
                        mapContainer.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 600px; font-size: 18px; color: #dc3545;">地图生成失败: ' + result.message + '</div>';
                    }
                } catch (error) {
                    const mapContainer = document.getElementById('map-container');
                    if (error.name === 'AbortError') {
                        mapContainer.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 600px; font-size: 18px; color: #dc3545;">地图生成超时，请稍后重试</div>';
                    } else {
                        console.error('地图生成时出现错误:', error);
                        mapContainer.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 600px; font-size: 18px; color: #dc3545;">地图生成失败: ' + error.message + '</div>';
                    }
                }
            },

            displayItinerary() {
                const container = document.getElementById('itinerary-result');
                container.innerHTML = '';

                if (!this.itinerary || this.itinerary.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">暂无行程数据</p>';
                    return;
                }

                // 批量构建HTML，减少DOM操作次数
                let html = '';

                this.itinerary.forEach(dayPlan => {
                    const dayNum = dayPlan.day;
                    const dayColors = ['blue', 'green', 'red', 'purple', 'orange', 'darkred', 'indigo'];
                    const dayColor = dayColors[(dayNum - 1) % dayColors.length];

                    // 直接使用所有景点，不进行复杂的过滤操作
                    const attractionsToShow = dayPlan.attractions;
                    let startPoint = null;
                    let endPoint = null;

                    // 处理第一天的出发点和最后一天的返回点
                    if (dayNum === 1 && attractionsToShow.length > 1) {
                        startPoint = attractionsToShow[0];
                    }
                    if (dayNum === this.itinerary.length && attractionsToShow.length > 1) {
                        endPoint = attractionsToShow[attractionsToShow.length - 1];
                    }

                    // 构建天气信息HTML
                    let weatherHtml = '';
                    if (dayPlan.weather) {
                        weatherHtml = `<span class="weather-info">${dayPlan.weather.weather}，${dayPlan.weather.temperature}°C</span>`;
                    }

                    // 构建出发点HTML
                    let startPointHtml = '';
                    if (startPoint) {
                        startPointHtml = `<div class="alert alert-info mb-3"><strong>出发点：</strong>${startPoint.name} (${startPoint.city})</div>`;
                    }

                    // 构建景点列表HTML
                    let attractionsHtml = '';
                    if (attractionsToShow.length > 0) {
                        attractionsHtml = attractionsToShow.map((attraction, i) => {
                            const rating = attraction.rating || '暂无评分';
                            const price = attraction.price || 0;
                            return `<div class="attraction-item">
                                <div class="d-flex justify-content-between">
                                    <strong>${i + 1}. ${attraction.name}</strong>
                                    <span class="badge bg-secondary">${attraction.city}</span>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        类型：${attraction.type} | 评分：${rating} | 价格：${price}元
                                    </small>
                                </div>
                            </div>`;
                        }).join('');
                    } else {
                        attractionsHtml = '<p class="text-center text-muted">暂无推荐景点</p>';
                    }

                    // 构建返回点HTML
                    let endPointHtml = '';
                    if (endPoint) {
                        endPointHtml = `<div class="alert alert-info mt-3"><strong>返回点：</strong>${endPoint.name} (${endPoint.city})</div>`;
                    }

                    // 构建完整的卡片HTML
                    html += `<div class="card itinerary-card">
                <div class="card-header bg-${dayColor} text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <span class="badge bg-white text-${dayColor} day-badge mr-2">${dayNum}</span>
                            第${dayNum}天行程
                        </h5>${weatherHtml}
                        </div>
                </div>
                <div class="card-body">${startPointHtml}
                    <h6>推荐景点：</h6>
                    <div class="mt-2">${attractionsHtml}</div>${endPointHtml}
                </div>
            </div>`;
                });

                // 一次性插入所有HTML，减少DOM重排
                container.innerHTML = html;
                container.style.display = 'block';
            },

            displayMap() {
                if (!this.mapHtml) return;

                const mapContainer = document.getElementById('map-container');
                mapContainer.innerHTML = this.mapHtml;
                document.getElementById('map-card').style.display = 'block';
            },

            triggerMapRedraw() {
                // 触发地图重绘，确保地图正确显示
                const mapCard = document.getElementById('map-card');
                const mapContainer = document.getElementById('map-container');

                // 强制浏览器重排，确保地图元素正确渲染
                mapContainer.offsetHeight; // 触发重排

                // 如果地图中包含folium地图，尝试重新初始化地图
                if (window.L && mapContainer.querySelector('.leaflet-container')) {
                    // 查找所有地图实例并触发重绘
                    const mapElements = mapContainer.querySelectorAll('.leaflet-container');
                    mapElements.forEach(element => {
                        // 尝试获取地图实例并触发重绘
                        const map = window.L.DomUtil.get(element)._leaflet_id;
                        if (map) {
                            const mapInstance = window.L._mapInstances[map];
                            if (mapInstance) {
                                mapInstance.invalidateSize();
                                mapInstance.redraw();
                            }
                        }
                    });
                }

                console.log('地图重绘触发完成');
            },

            showLoading() {
                document.getElementById('loading').style.display = 'block';
            },

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            },

            hideAll() {
                document.getElementById('map-card').style.display = 'none';
                document.getElementById('itinerary-result').style.display = 'none';
                document.getElementById('weather-section').style.display = 'none';
            },

            showWeatherSection() {
                document.getElementById('weather-section').style.display = 'block';
                this.generateWeatherOptions();
            },

            async loadItinerary(itineraryId) {
                """加载历史行程"""
                try {
                    const response = await fetch('/path/history/' + itineraryId, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.itinerary = result.itinerary;
                            await this.generateMap();
                            this.displayItinerary();
                            this.showWeatherSection();
                            // 显示保存行程按钮
                            document.getElementById('save-itinerary').style.display = 'block';
                        } else {
                            alert('加载行程失败: ' + result.message);
                        }
                    }
                } catch (error) {
                    console.error('加载行程失败:', error);
                    alert('加载行程时出现错误，请稍后重试');
                }
            },

            async deleteItinerary(itineraryId) {
                """删除历史行程"""
                if (confirm('确定要删除此行程吗？')) {
                    try {
                        const response = await fetch('/path/history/' + itineraryId, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                alert('行程删除成功！');
                                this.loadHistoryItineraries(); // 重新加载历史行程
                            } else {
                                alert('删除行程失败: ' + result.message);
                            }
                        }
                    } catch (error) {
                        console.error('删除行程失败:', error);
                        alert('删除行程时出现错误，请稍后重试');
                    }
                }
            },

            generateWeatherOptions() {
                const container = document.getElementById('weather-forecast');
                container.innerHTML = '';

                if (!this.itinerary) return;

                this.itinerary.forEach((dayPlan, index) => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'mb-2';
                    dayDiv.innerHTML = "\n                        <div class=\"form-group\">\n                            <label>第" + (index + 1) + "天天气</label>\n                            <select class=\"form-select\" id=\"weather-" + index + ">\n                                <option value=\"晴\">晴</option>\n                                <option value=\"多云\">多云</option>\n                                <option value=\"阴\">阴</option>\n                                <option value=\"小雨\">小雨</option>\n                                <option value=\"中雨\">中雨</option>\n                                <option value=\"大雨\">大雨</option>\n                                <option value=\"雪\">雪</option>\n                            </select>\n                        </div>\n                    ";
                    container.appendChild(dayDiv);
                });
            }
        },
        mounted() {
            // 测试生成路径按钮是否存在
            const generateBtn = document.getElementById('generate-path-btn');
            console.log('generate-path-btn元素:', generateBtn);

            // 保存Vue实例的引用，用于事件监听器中
            const vueInstance = this;

            // 如果生成路径按钮存在，添加点击事件监听器
            if (generateBtn) {
                generateBtn.addEventListener('click', function () {
                    console.log('生成路径按钮点击事件被触发');
                    // 使用vueInstance而不是this，确保指向Vue实例
                    vueInstance.generatePath();
                });
            } else {
                console.error('generate-path-btn元素不存在');

                // 备选方案：如果按钮不存在，使用表单提交事件
                const pathForm = document.getElementById('path-form');
                if (pathForm) {
                    pathForm.addEventListener('submit', function (e) {
                        console.log('表单提交事件被触发');
                        e.preventDefault();
                        // 使用vueInstance而不是this，确保指向Vue实例
                        vueInstance.generatePath();
                    });
                } else {
                    console.error('path-form元素不存在');
                }
            }

            // 评分滑块事件
            const minRatingSlider = document.getElementById('min-rating');
            const ratingValue = document.getElementById('rating-value');
            minRatingSlider.addEventListener('input', (e) => {
                ratingValue.textContent = e.target.value;
            });

            // 保存行程事件
            document.getElementById('save-itinerary').addEventListener('click', async () => {
                await this.saveItinerary();
            });

            // 天气调整事件
            document.getElementById('adjust-weather').addEventListener('click', async () => {
                if (!this.itinerary) return;

                this.isLoading = true;
                this.hideAll();
                this.showLoading();

                try {
                    // 获取天气选项
                    const weatherForecast = [];
                    for (let i = 0; i < this.itinerary.length; i++) {
                        const weatherSelect = document.getElementById('weather-' + i);
                        weatherForecast.push({
                            date: new Date().toISOString().split('T')[0],
                            weather: weatherSelect.value,
                            temperature: '15°C',
                            wind: '3级'
                        });
                    }

                    // 发送请求，设置超时时间为10秒
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    const response = await fetch('/path/adjust_weather', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            itinerary: this.itinerary,
                            weather_forecast: weatherForecast
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error('HTTP错误! 状态码: ' + response.status);
                    }

                    const result = await response.json();

                    if (result.success) {
                        this.itinerary = result.adjusted_itinerary;
                        await this.generateMap();
                        this.displayItinerary();
                        this.showWeatherSection(); // 天气调整后重新显示天气调整功能区
                    } else {
                        alert('天气调整失败: ' + result.message);
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        alert('天气调整超时，请稍后重试');
                    } else {
                        console.error('Error adjusting weather:', error);
                        alert('天气调整时出现错误，请稍后重试: ' + error.message);
                    }
                } finally {
                    this.isLoading = false;
                    this.hideLoading();
                }
            });

            // 页面加载时加载历史行程
            this.loadHistoryItineraries();
        }
    });

    // 检查#app元素是否存在
    const appElement = document.getElementById('app');
    console.log('#app元素:', appElement);

    if (appElement) {
        console.log('Vue 应用开始挂载到 #app 元素');
        app.mount('#app');
        console.log('Vue 应用挂载完成');
    } else {
        console.error('#app元素不存在');
        // 如果Vue应用挂载失败，使用原生JavaScript实现路径生成
        const generateBtn = document.getElementById('generate-path-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', () => {
                console.log('原生JavaScript生成路径按钮点击事件被触发');

                // 直接调用后端API
                const startCity = document.getElementById('start-city').value;
                const targetCity = document.getElementById('target-city').value;
                const days = parseInt(document.getElementById('days').value);
                const attractionTypes = Array.from(
                    document.getElementById('attraction-types').selectedOptions
                ).map(option => option.value);
                const minRating = parseFloat(document.getElementById('min-rating').value);

                const data = {
                    start_city: startCity,
                    target_city: targetCity,
                    days: days,
                    preferences: {
                        attraction_types: attractionTypes,
                        min_rating: minRating
                    }
                };

                console.log('请求数据:', data);

                // 显示加载状态
                document.getElementById('loading').style.display = 'block';

                // 发送请求
                fetch('/path/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        console.log('响应数据:', result);

                        if (result.success) {
                            alert('路径生成成功！');
                        } else {
                            alert('路径生成失败: ' + result.message);
                        }
                    })
                    .catch(error => {
                        console.error('请求失败:', error);
                        alert('请求失败: ' + error.message);
                    })
                    .finally(() => {
                        // 隐藏加载状态
                        document.getElementById('loading').style.display = 'none';
                    });
            });
        } else {
            console.error('generate-path-btn元素不存在，无法使用原生JavaScript实现路径生成');
        }
    }
</script>
{% endblock %}