{% extends "base.html" %}

{% block title %}收藏详情{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">收藏详情</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('user_profile.profile') }}">个人资料</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('user_profile.favorites') }}">我的收藏夹</a></li>
        <li class="breadcrumb-item active">收藏详情</li>
    </ol>

    <!-- 消息提示 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- 收藏详情卡片 -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-star-fill me-1"></i> {{ favorite.name }}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>基本信息</h5>
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <th scope="row">收藏名称:</th>
                                <td>{{ favorite.name }}</td>
                            </tr>
                            <tr>
                                <th scope="row">收藏类型:</th>
                                <td>
                                    {% if favorite.favorite_type == 'query' %}
                                    <span class="badge bg-primary">数据查询</span>
                                    {% elif favorite.favorite_type == 'recommendation' %}
                                    <span class="badge bg-success">旅游推荐</span>
                                    {% elif favorite.favorite_type == 'prediction' %}
                                    <span class="badge bg-info">天气预测</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ favorite.favorite_type }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">创建时间:</th>
                                <td>{{ favorite.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <h5>操作</h5>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('user_profile.favorites') }}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-1"></i> 返回收藏列表
                        </a>
                        <a href="{{ url_for('user_profile.delete_favorite', favorite_id=favorite.id) }}"
                            class="btn btn-danger" onclick="return confirm('确定要删除该收藏吗？')">
                            <i class="bi bi-trash-fill me-1"></i> 删除收藏
                        </a>
                    </div>
                </div>
            </div>

            <hr>

            <h5>收藏内容</h5>
            <div class="mt-3">
                <!-- 根据收藏类型显示不同格式的内容 -->
                {% if favorite.favorite_type == 'recommendation' %}
                <!-- 旅游推荐收藏 -->
                {% if content.filters %}
                <div class="bg-light p-3 rounded border mb-4">
                    <h6 class="fw-bold mb-3">推荐条件</h6>
                    <table class="table table-borderless">
                        <tbody>
                            {% if content.filters.city and content.filters.city != '' %}
                            <tr>
                                <th scope="row" class="w-25">目标城市:</th>
                                <td>{{ content.filters.city }}</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.date and content.filters.date != '' %}
                            <tr>
                                <th scope="row">推荐日期:</th>
                                <td>{{ content.filters.date }}</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.season and content.filters.season != '' %}
                            <tr>
                                <th scope="row">最佳季节:</th>
                                <td>{{ content.filters.season }}</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.type and content.filters.type != '' %}
                            <tr>
                                <th scope="row">推荐类型:</th>
                                <td>{{ content.filters.type }}</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.top_n and content.filters.top_n != '' %}
                            <tr>
                                <th scope="row">推荐数量:</th>
                                <td>{{ content.filters.top_n }} 个</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.min_rating and content.filters.min_rating != '' %}
                            <tr>
                                <th scope="row">最低评分:</th>
                                <td>{{ content.filters.min_rating }}</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.attraction_type and content.filters.attraction_type|length > 0 %}
                            <tr>
                                <th scope="row">选择的景点类型:</th>
                                <td>
                                    {% for type in content.filters.attraction_type %}
                                    <span class="badge bg-info me-1">{{ type }}</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if content.filters.is_free is not none and content.filters.is_free != '' %}
                            <tr>
                                <th scope="row">是否免费:</th>
                                <td>{% if content.filters.is_free == 'true' %}免费景点{% elif content.filters.is_free ==
                                    'false' %}付费景点{% else %}全部{% endif %}</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.max_price and content.filters.max_price != '' %}
                            <tr>
                                <th scope="row">最高票价:</th>
                                <td>{{ content.filters.max_price }} 元</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.selected_seasons and content.filters.selected_seasons|length > 0 %}
                            <tr>
                                <th scope="row">选择的季节:</th>
                                <td>
                                    {% for season in content.filters.selected_seasons %}
                                    <span class="badge bg-primary me-1">{{ season }}</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <!-- 显示推荐结果 -->
                {% if content.recommendations and content.recommendations|length > 0 %}
                <div class="bg-light p-3 rounded border">
                    <h6 class="fw-bold mb-3">推荐结果</h6>
                    <div class="row">
                        {% for rec in content.recommendations %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 hover-shadow">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="card-title mb-0">{{ rec['城市'] }} - {{ rec['景点名称'] }}</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <span class="badge bg-secondary me-1">{{ rec['景点类型'] }}</span>
                                        <span class="badge bg-success me-1">评分: {{ rec['评分'] }}</span>
                                        <span class="badge bg-info">最佳季节: {{ rec['最佳季节'] }}</span>
                                    </div>
                                    <p class="mb-2">{{ rec['简介'] }}</p>
                                    <div class="row text-sm text-muted">
                                        <div class="col-6">门票: {% if rec['门票价格'] == 0 %}免费{% else %}{{ rec['门票价格'] }}元{%
                                            endif %}</div>
                                        <div class="col-6">游玩时长: {{ rec['推荐游玩时长'] or '未知' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info" role="alert">
                    暂无推荐结果
                </div>
                {% endif %}
                {% elif favorite.favorite_type == 'prediction' %}
                <!-- 天气预测收藏 -->
                {% if content.filters %}
                <div class="bg-light p-3 rounded border">
                    <h6 class="fw-bold mb-3">预测条件</h6>
                    <table class="table table-borderless">
                        <tbody>
                            {% if content.filters.city and content.filters.city != '' %}
                            <tr>
                                <th scope="row" class="w-25">预测城市:</th>
                                <td>{{ content.filters.city }}</td>
                            </tr>
                            {% endif %}
                            {% if content.filters.days and content.filters.days != '' %}
                            <tr>
                                <th scope="row">预测天数:</th>
                                <td>{{ content.filters.days }} 天</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="bg-light p-3 rounded border">
                    <h6 class="fw-bold mb-3">预测条件</h6>
                    <table class="table table-borderless">
                        <tbody>
                            {% if content.city and content.city != '' %}
                            <tr>
                                <th scope="row" class="w-25">预测城市:</th>
                                <td>{{ content.city }}</td>
                            </tr>
                            {% endif %}
                            {% if content.days and content.days != '' %}
                            <tr>
                                <th scope="row">预测天数:</th>
                                <td>{{ content.days }} 天</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                
                <!-- 预测结果 -->
                {% if content.error %}
                <div class="alert alert-danger mt-3" role="alert">
                    预测执行失败: {{ content.error }}
                </div>
                {% elif content.predictions and content.predictions|length > 0 %}
                <div class="mt-4">
                    <h6 class="fw-bold mb-3">预测结果</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>天气状况</th>
                                    <th>最高气温 (℃)</th>
                                    <th>最低气温 (℃)</th>
                                    <th>平均气温 (℃)</th>
                                    <th>风力(白天)</th>
                                    <th>风力(夜间)</th>
                                    <th>旅游评分</th>
                                    <th>推荐指数</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pred in content.predictions %}
                                <tr
                                    class="{% if pred['推荐指数'] == '强烈推荐' %}table-success{% elif pred['推荐指数'] == '推荐' %}table-info{% elif pred['推荐指数'] == '一般' %}table-warning{% else %}table-danger{% endif %}">
                                    <td>{{ pred['日期'].strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% set avg_temp = pred['平均气温'] | default(0) | round(1) %}
                                        {% set wind_day = pred['风力(白天)_数值'] | default(0) | round(1) %}
                                        
                                        {% if avg_temp > 25 %}
                                            <i class="bi bi-sun text-warning" style="font-size: 1.5rem;"></i>
                                        {% elif avg_temp > 15 %}
                                            {% if wind_day > 3 %}
                                                <i class="bi bi-cloud-sun text-info" style="font-size: 1.5rem;"></i>
                                            {% else %}
                                                <i class="bi bi-cloud text-info" style="font-size: 1.5rem;"></i>
                                            {% endif %}
                                        {% elif avg_temp > 5 %}
                                            <i class="bi bi-cloud-drizzle text-primary" style="font-size: 1.5rem;"></i>
                                        {% else %}
                                            <i class="bi bi-snow text-light" style="font-size: 1.5rem;"></i>
                                        {% endif %}
                                    </td>
                                    <td>{{ pred['最高气温'] | default(0) | round(1) }}</td>
                                    <td>{{ pred['最低气温'] | default(0) | round(1) }}</td>
                                    <td>{{ pred['平均气温'] | default(0) | round(1) }}</td>
                                    <td>{{ (pred['风力(白天)_数值'] | default(0) | round(1)) }} 级</td>
                                    <td>{{ (pred['风力(夜间)_数值'] | default(0) | round(1)) }} 级</td>
                                    <td>{{ pred['旅游评分'] }}</td>
                                    <td>{{ pred['推荐指数'] }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 基于预测结果的旅游推荐 -->
                <div class="mt-4">
                    <h6 class="fw-bold mb-3">基于预测天气的旅游推荐</h6>
                    {% if content.future_recommendations and content.future_recommendations|length > 0 %}
                    <div class="row">
                        {% for day_rec in content.future_recommendations %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="card-title mb-0">{{ day_rec['date'] }}</h6>
                                </div>
                                <div class="card-body">
                                    {% if day_rec['recommendations'] %}
                                    <ul class="list-group list-group-flush">
                                        {% for rec in day_rec['recommendations'] %}
                                        <li class="list-group-item">
                                            <h7 class="fw-bold">{{ rec['景点名称'] }}</h7>
                                            <p class="mb-1 text-muted small">{{ rec['景点类型'] }} | 评分: {{ rec['评分'] }}</p>
                                            <p class="mb-1 text-sm">{{ rec['简介'][:100] }}...</p>
                                            <div class="text-xs text-muted">
                                                最佳季节: {{ rec['最佳季节'] }} | 门票: {% if rec['门票价格'] == 0 %}免费{% else %}{{ rec['门票价格'] }}元{% endif %}
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <div class="text-center text-muted py-3">
                                        暂无推荐景点
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info" role="alert">
                        暂无推荐数据
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-info mt-3" role="alert">
                    暂无预测结果
                </div>
                {% endif %}
                {% elif favorite.favorite_type == 'query' %}
                <!-- 数据查询收藏 -->
                <div class="bg-light p-3 rounded border">
                    <h6 class="fw-bold mb-3">查询条件</h6>
                    <table class="table table-borderless">
                        <tbody>
                            {% if content.city and content.city != '' %}
                            <tr>
                                <th scope="row" class="w-25">查询城市:</th>
                                <td>{{ content.city }}</td>
                            </tr>
                            {% endif %}
                            {% if content.start_date and content.start_date != '' %}
                            <tr>
                                <th scope="row">开始日期:</th>
                                <td>{{ content.start_date }}</td>
                            </tr>
                            {% endif %}
                            {% if content.end_date and content.end_date != '' %}
                            <tr>
                                <th scope="row">结束日期:</th>
                                <td>{{ content.end_date }}</td>
                            </tr>
                            {% endif %}
                            {% if content.weather and content.weather != '' %}
                            <tr>
                                <th scope="row">天气状况:</th>
                                <td>{{ content.weather }}</td>
                            </tr>
                            {% endif %}
                            {% if content.wind_dir and content.wind_dir != '' %}
                            <tr>
                                <th scope="row">风向:</th>
                                <td>{{ content.wind_dir }}</td>
                            </tr>
                            {% endif %}
                            {% if content.wind_lvl and content.wind_lvl != '' %}
                            <tr>
                                <th scope="row">风力:</th>
                                <td>{{ content.wind_lvl }}</td>
                            </tr>
                            {% endif %}
                            {% if content.temp_min and content.temp_min != '' %}
                            <tr>
                                <th scope="row">最低气温 ≥:</th>
                                <td>{{ content.temp_min }}℃</td>
                            </tr>
                            {% endif %}
                            {% if content.temp_max and content.temp_max != '' %}
                            <tr>
                                <th scope="row">最高气温 ≤:</th>
                                <td>{{ content.temp_max }}℃</td>
                            </tr>
                            {% endif %}
                            {% if content.time_period and content.time_period != '' %}
                            <tr>
                                <th scope="row">时间段:</th>
                                <td>{% if content.time_period == 'day' %}白天{% elif content.time_period == 'night' %}夜间{% else %}全天{% endif %}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 查询结果 -->
                {% if content.error %}
                <div class="alert alert-danger mt-3" role="alert">
                    查询执行失败: {{ content.error }}
                </div>
                {% elif content.results and content.results|length > 0 %}
                <div class="mt-4">
                    <h6 class="fw-bold mb-3">查询结果</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>城市</th>
                                    <th>日期</th>
                                    <th>最高气温</th>
                                    <th>最低气温</th>
                                    <th>天气状况(白天)</th>
                                    <th>天气状况(夜间)</th>
                                    <th>风向(白天)</th>
                                    <th>风力(白天)</th>
                                    <th>风向(夜间)</th>
                                    <th>风力(夜间)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in content.results %}
                                <tr>
                                    <td>{{ row['城市'] }}</td>
                                    <td>{{ row['日期'] }}</td>
                                    <td>{{ row['最高气温'] }}</td>
                                    <td>{{ row['最低气温'] }}</td>
                                    <td>{{ row['天气状况(白天)'] }}</td>
                                    <td>{{ row['天气状况(夜间)'] }}</td>
                                    <td>{{ row['风向(白天)'] }}</td>
                                    <td>{{ row['风力(白天)_数值'] }}级</td>
                                    <td>{{ row['风向(夜间)'] }}</td>
                                    <td>{{ row['风力(夜间)_数值'] }}级</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if content.results|length >= 20 %}
                    <div class="alert alert-info mt-2" role="alert">
                        只显示前20条查询结果
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-info mt-3" role="alert">
                    暂无查询结果
                </div>
                {% endif %}
                {% else %}
                <!-- 其他类型收藏，以结构化方式显示 -->
                <div class="bg-light p-3 rounded border">
                    <h6 class="fw-bold mb-3">收藏详情</h6>
                    <table class="table table-borderless">
                        <tbody>
                            {% for key, value in content.items() %}
                            <tr>
                                <th scope="row" class="w-25 text-capitalize">
                                    {% if key == 'city' %}城市
                                    {% elif key == 'date' %}日期
                                    {% elif key == 'days' %}天数
                                    {% elif key == 'type' %}类型
                                    {% elif key == 'top_n' %}推荐数量
                                    {% elif key == 'min_rating' %}最低评分
                                    {% elif key == 'max_price' %}最高票价
                                    {% elif key == 'is_free' %}是否免费
                                    {% elif key == 'season' %}季节
                                    {% elif key == 'attraction_type' %}景点类型
                                    {% elif key == 'start_date' %}开始日期
                                    {% elif key == 'end_date' %}结束日期
                                    {% elif key == 'weather_condition' %}天气状况
                                    {% elif key == 'selected_seasons' %}选择的季节
                                    {% elif key == 'filters' %}筛选条件
                                    {% elif key == 'recommendations' %}推荐结果
                                    {% else %}{{ key }}
                                    {% endif %}
                                </th>
                                <td>
                                    {% if key == 'filters' %}
                                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#filtersCollapse" aria-expanded="false"
                                        aria-controls="filtersCollapse">
                                        查看筛选条件
                                    </button>
                                    <div class="collapse mt-2" id="filtersCollapse">
                                        <div class="bg-light p-3 rounded border">
                                            <table class="table table-borderless">
                                                <tbody>
                                                    {% for filter_key, filter_value in value.items() %}
                                                    <tr>
                                                        <th scope="row" class="w-25 text-capitalize">{{ filter_key }}
                                                        </th>
                                                        <td>
                                                            {% if filter_value is iterable and filter_value is not
                                                            string %}
                                                            {% for item in filter_value %}
                                                            <span class="badge bg-info me-1">{{ item }}</span>
                                                            {% endfor %}
                                                            {% elif filter_value == '' %}
                                                            <span class="text-muted">无</span>
                                                            {% else %}
                                                            {{ filter_value }}
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% elif key == 'recommendations' %}
                                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#recommendationsCollapse" aria-expanded="false"
                                        aria-controls="recommendationsCollapse">
                                        查看推荐结果 ({{ value|length }} 个)
                                    </button>
                                    <div class="collapse mt-2" id="recommendationsCollapse">
                                        <div class="bg-light p-3 rounded border">
                                            <div class="row">
                                                {% for rec in value %}
                                                <div class="col-md-4 mb-4">
                                                    <div class="card h-100 hover-shadow">
                                                        <div class="card-header bg-primary text-white">
                                                            <h6 class="card-title mb-0">{{ rec['城市'] }} - {{ rec['景点名称']
                                                                }}</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="mb-2">
                                                                <span class="badge bg-secondary me-1">{{ rec['景点类型']
                                                                    }}</span>
                                                                <span class="badge bg-success me-1">评分: {{ rec['评分']
                                                                    }}</span>
                                                                <span class="badge bg-info">最佳季节: {{ rec['最佳季节']
                                                                    }}</span>
                                                            </div>
                                                            <p class="mb-2">{{ rec['简介'] }}</p>
                                                            <div class="row text-sm text-muted">
                                                                <div class="col-6">门票: {% if rec['门票价格'] == 0 %}免费{%
                                                                    else %}{{ rec['门票价格'] }}元{% endif %}</div>
                                                                <div class="col-6">游玩时长: {{ rec['推荐游玩时长'] or '未知' }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% elif key == 'attraction_type' and value is iterable and value is not string %}
                                    {% for item in value %}
                                    <span class="badge bg-info me-1">{{ item }}</span>
                                    {% endfor %}
                                    {% elif key == 'is_free' %}
                                    {% if value %}是{% else %}否{% endif %}
                                    {% elif value == '' %}
                                    <span class="text-muted">无</span>
                                    {% else %}
                                    {{ value }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}